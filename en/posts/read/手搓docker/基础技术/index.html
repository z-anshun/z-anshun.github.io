<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/z-anshun/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=z-anshun/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>åŸºç¡€æŠ€æœ¯ | Noodles2hgçš„åšå®¢</title>
<meta name="keywords" content="docker, books">
<meta name="description" content="Docker ä»€ä¹ˆæ˜¯dockerï¼Ÿ ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå°†åº”ç”¨æ‰“åŒ…ä¸ºé•œåƒï¼Œå¹¶ä»¥å®¹å™¨æ–¹å¼è¿è¡Œ Docker å®¹å™¨å…·æœ‰ä¸‹é¢ä¸‰ä¸ªç‰¹ç‚¹ï¼š è½»é‡çº§ï¼šå…±äº«å†…æ ¸ï¼Œå¹¶ä¸”å› ä¸ºé•œåƒä»¥åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿæ„">
<meta name="author" content="Noodles2hg">
<link rel="canonical" href="http://localhost:1313/z-anshun/en/posts/read/%E6%89%8B%E6%90%93docker/%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF/">
<link crossorigin="anonymous" href="/z-anshun/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/z-anshun/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/z-anshun/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/z-anshun/img/Q.gif">
<link rel="apple-touch-icon" href="http://localhost:1313/z-anshun/Q.gif">
<link rel="mask-icon" href="http://localhost:1313/z-anshun/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/z-anshun/en/posts/read/%E6%89%8B%E6%90%93docker/%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="åŸºç¡€æŠ€æœ¯" />
<meta property="og:description" content="Docker ä»€ä¹ˆæ˜¯dockerï¼Ÿ ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå°†åº”ç”¨æ‰“åŒ…ä¸ºé•œåƒï¼Œå¹¶ä»¥å®¹å™¨æ–¹å¼è¿è¡Œ Docker å®¹å™¨å…·æœ‰ä¸‹é¢ä¸‰ä¸ªç‰¹ç‚¹ï¼š è½»é‡çº§ï¼šå…±äº«å†…æ ¸ï¼Œå¹¶ä¸”å› ä¸ºé•œåƒä»¥åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿæ„" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/z-anshun/en/posts/read/%E6%89%8B%E6%90%93docker/%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-10T18:12:37+00:00" />
<meta property="article:modified_time" content="2022-03-10T18:12:37+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="åŸºç¡€æŠ€æœ¯"/>
<meta name="twitter:description" content="Docker ä»€ä¹ˆæ˜¯dockerï¼Ÿ ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå°†åº”ç”¨æ‰“åŒ…ä¸ºé•œåƒï¼Œå¹¶ä»¥å®¹å™¨æ–¹å¼è¿è¡Œ Docker å®¹å™¨å…·æœ‰ä¸‹é¢ä¸‰ä¸ªç‰¹ç‚¹ï¼š è½»é‡çº§ï¼šå…±äº«å†…æ ¸ï¼Œå¹¶ä¸”å› ä¸ºé•œåƒä»¥åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿæ„"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/z-anshun/en/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“•é˜…è¯»",
      "item": "http://localhost:1313/z-anshun/en/posts/read/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "åŸºç¡€æŠ€æœ¯",
      "item": "http://localhost:1313/z-anshun/en/posts/read/%E6%89%8B%E6%90%93docker/%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "åŸºç¡€æŠ€æœ¯",
  "name": "åŸºç¡€æŠ€æœ¯",
  "description": "Docker ä»€ä¹ˆæ˜¯dockerï¼Ÿ ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå°†åº”ç”¨æ‰“åŒ…ä¸ºé•œåƒï¼Œå¹¶ä»¥å®¹å™¨æ–¹å¼è¿è¡Œ Docker å®¹å™¨å…·æœ‰ä¸‹é¢ä¸‰ä¸ªç‰¹ç‚¹ï¼š è½»é‡çº§ï¼šå…±äº«å†…æ ¸ï¼Œå¹¶ä¸”å› ä¸ºé•œåƒä»¥åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿæ„",
  "keywords": [
    "docker", "books"
  ],
  "articleBody": "Docker ä»€ä¹ˆæ˜¯dockerï¼Ÿ\nä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå°†åº”ç”¨æ‰“åŒ…ä¸ºé•œåƒï¼Œå¹¶ä»¥å®¹å™¨æ–¹å¼è¿è¡Œ\nDocker å®¹å™¨å…·æœ‰ä¸‹é¢ä¸‰ä¸ªç‰¹ç‚¹ï¼š\nè½»é‡çº§ï¼šå…±äº«å†…æ ¸ï¼Œå¹¶ä¸”å› ä¸ºé•œåƒä»¥åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿæ„é€ ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¯ä»¥å…±äº«ç›¸åŒçš„æ–‡ä»¶ï¼Œä½¿å¾—ç£ç›˜ä½¿ç”¨ç‡å’Œé•œåƒä¸‹è½½é€Ÿåº¦éƒ½æé«˜ å¼€æ”¾ï¼š å®‰å…¨ï¼šéš”ç¦» Linux Namespace æ¦‚å¿µ Linux Namespace æ˜¯ Kernel çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå¯ä»¥éš”ç¦»ä¸€ç³»åˆ—çš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚ï¼šPIDã€User IDã€Networkã€è¿›ç¨‹èµ„æºç­‰ã€‚æ—¢ç„¶åŒ…æ‹¬äº†è¿›ç¨‹èµ„æºï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹æ•°ã€ç½‘ç»œæ¥å£ç­‰ï¼Œè¿™é‡Œå°±ä¸èƒ½ä½¿ç”¨chrootå®ç°äº†ï¼ˆæŠŠæ ¹ç›®å½•æ¢æˆæŒ‡å®šçš„ç›®çš„ç›®å½•ï¼‰\nå½“å‰ Linux å®ç°çš„ 6 ç§ Namespace\nNamespaceç±»å‹ ç³»ç»Ÿè°ƒç”¨å‚æ•° å†…æ ¸ç‰ˆæœ¬ Mount Namespace CLONE_NEWNS 2.4.19 UTS Namespcae CLONE_NEWUTS 2.6.19 IPC Namespace CLONE_NEWIPC 2.6.19 PID Namespcae CLONE_NEWPID 2.6.24 Network Namespace CLONE_NEWNET 2.6.29 User Namespace CLONE_NEWUSER 3.8 Namespace çš„ API ä¸»è¦ä½¿ç”¨ä¸‹é¢3ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š\nclone()ï¼šåˆ›å»ºæ–°è¿›ç¨‹ï¼Œæ ¹æ®ç³»ç»Ÿè°ƒç”¨å‚æ•°æ¥åˆ¤æ–­å“ªäº›ç±»å‹çš„ Namespace è¢«åˆ›å»ºï¼Œè€Œä¸”å®ƒä»¬çš„å­è¿›ç¨‹ä¹Ÿä¼šè¢«åŒ…å«åˆ°è¿™äº› Namespace ä¸­ unshare()ï¼šå°†è¿›ç¨‹ç§»é™¤æŸä¸ª Namespace setns()ï¼šå°†è¿›ç¨‹åŠ å…¥åˆ° Namespace UTS Namespace UNIX Time-sharing System\nå…è®¸æ¯ä¸ªå®¹å™¨æ‹¥æœ‰ç‹¬ç«‹çš„ hostname å’Œdomain nameï¼Œä½¿å…¶åœ¨ç½‘ç»œä¸Šå¯è¢«è§†ä½œä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è€Œéä¸»æœºä¸Šçš„ä¸€ä¸ªè¿›ç¨‹\nç®€å•çš„ä»£ç å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package main import ( \"os/exec\" \"syscall\" \"os\" \"log\" ) func main() { // æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤ cmd:=exec.Command(\"sh\") // è®¾ç½®å‚æ•°ç³»ç»Ÿï¼Œä½¿ç”¨æ ‡è¯†å»åˆ›å»ºä¸€ä¸ª UTS Namespaceã€‚å¹¶ä¸” GO å°è£…äº†å¯¹ clone() å‡½æ•°çš„è°ƒç”¨ cmd.SysProcAttr = \u0026syscall.SysProcAttr{ Cloneflags: syscall.CLONE_NEWUTS, } cmd.Stdin = os.Stdin cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr if err := cmd.Run(); err!=nil{ log.Fatal(err) } } å¯åŠ¨åï¼ŒéªŒè¯çˆ¶å­è¿›ç¨‹ä¸åœ¨åŒä¸€ä¸ªUST Namespaceï¼š\nä½¿ç”¨pstree -plæŸ¥çœ‹çˆ¶å­è¿›ç¨‹çš„IDï¼Œç„¶åä½¿ç”¨readlink /proc/$PID/ns/utséªŒè¯å¾—åˆ°çˆ¶å­è¿›ç¨‹ä¸åœ¨åŒä¸€ä¸ªUTS Namespace\nä¿®æ”¹å½“å‰å¯åŠ¨çš„shçš„hostnameï¼ˆhostname -b $nameï¼‰ï¼Œä¹Ÿä¸ä¼šå½±å“å¤–éƒ¨\nIPC Namespace ç”¨æ¥éš”ç¦» System V IPC å’Œ POSIX message queuesã€‚æ¯ä¸€ä¸ª IPC Namespace éƒ½æœ‰è‡ªå·±çš„ System V IPC å’Œ POSIX message queue\nä»£ç å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package main import ( \"os/exec\" \"syscall\" \"os\" \"log\" ) func main() { // æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤ cmd:=exec.Command(\"sh\") cmd.SysProcAttr = \u0026syscall.SysProcAttr{ Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC, } cmd.Stdin = os.Stdin cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr if err := cmd.Run(); err!=nil{ log.Fatal(err) } } ç›¸å½“äºï¼Œç°åœ¨å¤šåŠ äº†ä¸€ä¸ªæ ‡è¯†ï¼Œè¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›åˆ›å»º IPC Namespace\néªŒè¯ï¼š\né¦–å…ˆï¼Œåœ¨ä¸»æœºï¼Œä½¿ç”¨ipcsæŸ¥çœ‹ï¼Œç„¶åipcmkåˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå¯åŠ¨ï¼Œå‘ç°æ–°åˆ›å»ºçš„shä¸­ï¼ŒæŸ¥æ‰¾ä¸åˆ°è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå³å®ç° IPC å‘½ä»¤ç©ºé—´éš”ç¦»\nPID Namespace éš”ç¦»è¿›ç¨‹ IDï¼Œå³åŒä¸€ä¸ªè¿›ç¨‹åœ¨ä¸åŒçš„ PID Namespace é‡Œå¯ä»¥æ‹¥æœ‰ä¸åŒçš„ PIDã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯åœ¨å®¹å™¨å†…å¤–æŸ¥çœ‹åŒä¸€ä¸ªè¿›ç¨‹çš„ IDä¸åŒï¼Œæ¯”å¦‚ï¼Œå®¹å™¨å†… PIDä¸º1ï¼Œä½†æ˜¯åœ¨å®¹å™¨å¤–ï¼Œå´ä¸ä¸€æ ·ã€‚\nä»£ç å®ç°ï¼šæ·»åŠ  syscall.CLONE_NEWPIDæ ‡è¯†å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 package main import ( \"os/exec\" \"syscall\" \"os\" \"log\" ) func main() { // æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤ cmd:=exec.Command(\"sh\") cmd.SysProcAttr = \u0026syscall.SysProcAttr{ Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID, } cmd.Stdin = os.Stdin cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr if err := cmd.Run(); err!=nil{ log.Fatal(err) } } éªŒè¯ï¼š\né¦–å…ˆï¼Œè¿è¡ŒGoæ–‡ä»¶ï¼Œæ‰§è¡Œecho $$æ‰“å°å‡ºå½“å‰ PID ä¸º 1ï¼Œ\nç„¶åï¼Œåœ¨å¤–éƒ¨ä½¿ç”¨ pstree -pl æŸ¥çœ‹è¿›ç¨‹æ ‘ã€‚å‘ç° GO å¯¹åº”çš„è¿›ç¨‹ä¸ä¸º 1ï¼Œä¹Ÿå°±æ˜¯åœ¨å®¹å™¨å†…å¤–çš„ PIDä¸åŒï¼Œå®ç°äº† PID Namespace\nMount Namespace éš”ç¦»å„è¿›ç¨‹çœ‹åˆ°çš„æŒ‚è½½ç‚¹è§†å›¾ï¼Œå³åœ¨ä¸åŒå®¹å™¨ä¸­çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡æ˜¯ä¸åŒçš„ã€‚è€Œä¸”ï¼Œåœ¨ä¸åŒçš„å®¹å™¨ä¸­è°ƒç”¨mount()å’Œunmountåªä¼šå½±å“å½“å‰æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒï¼Œæˆ–è€…å…¨å±€ã€‚\nä¸ºä»€ä¹ˆ Mount Namespace çš„è°ƒç”¨å‚æ•°ä¸º CLONE_NEWNSï¼Œè€Œä¸æ˜¯è·Ÿå…¶å®ƒä¸€æ ·ï¼Œå¦‚ CLONE_NEWPID?\nå› ä¸ºå®ƒæ˜¯Linuxå®ç°çš„ç¬¬ä¸€ä¸ªNamespaceï¼Œå› æ­¤ä¸º NEWNSï¼ˆNew Namespaceç¼©å†™ï¼‰ã€‚è€Œä¸”å½“æ—¶æ²¡å¹¶æœªæƒ³åˆ°åé¢è¿˜æœ‰è®¸å¤š NamespaceåŠ å…¥\nä»£ç å®ç°ï¼Œè·Ÿä¸Šé¢ç±»ä¼¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package main import ( \"os/exec\" \"syscall\" \"os\" \"log\" ) func main() { // æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤ cmd:=exec.Command(\"sh\") cmd.SysProcAttr = \u0026syscall.SysProcAttr{ Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS, } cmd.Stdin = os.Stdin cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr if err := cmd.Run(); err!=nil{ log.Fatal(err) } os.Exit(-1) } éªŒè¯ï¼š\nè¿è¡Œä»£ç ï¼Œæ‰§è¡Œls /procæŸ¥çœ‹å†…æ ¸å’Œå†…æ ¸æ¨¡å—çš„ä¿¡æ¯ã€‚\nç„¶åï¼Œæ‰§è¡Œmount -t proc proc /procï¼Œå³ä½¿è®²å½“å‰ Namespace çš„ procæŒ‚è½½åˆ° /procï¼Œ\næ¥ç€ï¼Œæ‰§è¡Œls /procï¼Œè·Ÿä¸€å¼€å§‹çš„ä¿¡æ¯ä¸åŒï¼Œå› ä¸ºä¸€å¼€å§‹æœªæŒ‚è½½ï¼Œçœ‹çš„è¿˜æ˜¯å®¿ä¸»æœºçš„ï¼Œè€Œç°åœ¨æŒ‚è½½åï¼Œçœ‹åˆ°å°±æ˜¯ Namespace é‡Œçš„\næœ€åï¼Œæ‰§è¡Œps -efï¼Œçœ‹åˆ°shè¿›ç¨‹çš„IDä¸º1ï¼Œå³ä¸å¤–éƒ¨å®ç°éš”ç¦»ï¼Œmountå¹¶æ²¡æœ‰å½±å“åˆ°å¤–éƒ¨ï¼ˆpså‘½ä»¤ä¼šä½¿ç”¨/proc ä¸‹çš„å†…å®¹ï¼‰\nUser Namespace éš”ç¦»ç”¨æˆ·çš„ç”¨æˆ·ç»„IDã€‚ä¹Ÿå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„ User ID å’Œ Group IDåœ¨User Namespace å†…å¤–æ˜¯ä¸åŒçš„ã€‚è¾ƒä¸ºå¸¸ç”¨çš„å°±æ˜¯å®¿ä¸»æœºä¸Šä¸€ä¸ªé root ç”¨æˆ·è¿è¡Œåˆ›å»ºä¸€ä¸ª User Namespaceï¼Œç„¶ååœ¨User Namespace é‡Œå´æ˜ å°„ä¸º root ç”¨æˆ·ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥è¿›ç¨‹åœ¨ User Namespaceä¸­æœ‰rootæƒé™ï¼Œä½†åœ¨å¤–é¢å´æ²¡æœ‰rootæƒé™ã€‚\nä» Linux Kernel3.8 å¼€å§‹ï¼Œérootè¿›ç¨‹ä¹Ÿå¯ä»¥åˆ›å»º User Namespaceã€‚\nä»£ç å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package main import ( \"os/exec\" \"syscall\" \"os\" \"log\" ) func main() { // æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤ cmd:=exec.Command(\"sh\") cmd.SysProcAttr = \u0026syscall.SysProcAttr{ Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS | syscall.CLONE_NEWUSER, } cmd.SysProcAttr.Credential = \u0026syscall.Credential{Uid:uint32(1),Gid:uint32(1)} cmd.Stdin = os.Stdin cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr if err := cmd.Run(); err!=nil{ log.Fatal(err) } } éªŒè¯ï¼š\né¦–å…ˆï¼Œä½¿ç”¨ id æŸ¥çœ‹å½“å‰æ˜¯å¦ä¸º root ç”¨æˆ·ï¼Œç„¶åè¿è¡Œgo run main.go\nç„¶åï¼Œæ‰§è¡Œid æŸ¥çœ‹ Namespace ä¸­çš„ä¿¡æ¯ï¼Œå…¶UIDè·Ÿåˆšæ‰ä¸åŒï¼Œå³è¯æ˜User Namespace ç”Ÿæ•ˆ\nNetwork Namespace ç”¨æ¥éš”ç¦»ç½‘ç»œè®¾å¤‡ã€IP åœ°å€ç«¯å£ç­‰ç½‘ç»œæ ˆçš„Namespaceã€‚\nä½¿æ¯ä¸ªå®¹æ˜“æ‹¥æœ‰è‡ªå·±çš„ç½‘ç»œè®¾å¤‡ï¼ˆè™šæ‹Ÿï¼‰ï¼Œè€Œä¸”å®¹å™¨å†…å¯ä»¥è¿›è¡Œç«¯å£ç»‘å®šï¼Œæ¯ä¸ªNamespaceä¸­ä¹Ÿä¸ä¼šå†²çªï¼ˆå³ä¸åŒå®¹å™¨ä¹‹é—´å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç«¯å£ï¼‰\nä»£ç å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func main() { // æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤ cmd:=exec.Command(\"sh\") cmd.SysProcAttr = \u0026syscall.SysProcAttr{ Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS | syscall.CLONE_NEWUSER | syscall.CLONE_NEWNET, } cmd.SysProcAttr.Credential = \u0026syscall.Credential{Uid:uint32(1),Gid:uint32(1)} cmd.Stdin = os.Stdin cmd.Stdout = os.Stdout cmd.Stderr = os.Stderr if err := cmd.Run(); err!=nil{ log.Fatal(err) } } é¦–å…ˆï¼Œä½¿ç”¨ifconfigæŸ¥çœ‹å½“å‰çš„ç½‘ç»œè®¾å¤‡ï¼Œå‘ç°æœ‰loã€eth0ã€eth1ç­‰\nç„¶åï¼Œgo run main.goï¼Œå†åœ¨Namespaceä¸­è¿è¡Œifconfigï¼ŒæŸ¥çœ‹ä»€ä¹ˆç½‘ç»œè®¾å¤‡éƒ½æ²¡æœ‰ï¼ˆå› ä¸ºè¿™é‡Œå¹¶æ²¡æœ‰é…ç½®ç½‘æ¡¥ï¼‰\nLinux Cgroups æ§åˆ¶ç»„ï¼Œç¡®ä¿æ¯ä¸ªå®¹å™¨æ‰€å æœ‰çš„èµ„æºï¼Œè¿™æ ·ç¡®ä¿äº†å½“å®¹å™¨å†…çš„èµ„æºä½¿ç”¨äº§ç”Ÿå‹åŠ›æ—¶ä¸ä¼šè¿ç´¯ä¸»æœºç³»ç»Ÿã€‚ä¹Ÿå°±èƒ½é¢„é˜² DOOSæ”»å‡»\nCgroups ä¸­çš„ä¸‰ä¸ªç»„ä»¶ï¼š\ncgroupï¼šä¸€ç§å¯¹è¿›ç¨‹åˆ†ç»„ç®¡ç†çš„æœºåˆ¶ï¼Œä¸€ä¸ªcgroupå°±åŒ…å«äº†ä¸€ç»„è¿›ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å…¶é…ç½® Linux subsystem çš„å„ç§å‚æ•°é…ç½®ï¼Œå³è®²ä¸€ç»„è¿›ç¨‹å’Œä¸€ç»„ subsystem çš„ç³»ç»Ÿå‚æ•°å…³è”èµ·æ¥\nsubsystemï¼šä¸€ç»„èµ„æºæ§åˆ¶çš„æ¿å—ï¼ŒåŒ…å«å¦‚ä¸‹å‡ é¡¹:\nblkioï¼šè®¾ç½®å¯¹å—è®¾å¤‡ï¼ˆæ¯”å¦‚ç¡¬ç›˜ï¼‰è¾“å…¥è¾“å‡ºçš„è®¿é—®æ§åˆ¶ cpuï¼šè®¾ç½®cgroupä¸­è¿›ç¨‹çš„ CPU è¢«è°ƒåº¦çš„ç­–ç•¥ cpuacctï¼šå¯ä»¥ç»Ÿè®¡ cgroup ä¸­è¿›ç¨‹çš„CPUå ç”¨ cpusetï¼šåœ¨å¤šæ ¸æœºå™¨ä¸Šè®¾ç½® cgroup ä¸­è¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„ CPU å’Œå†…å­˜ï¼ˆæ­¤å¤„å†…å­˜ä»…ç”¨äº NUMA æ¶æ„ï¼ˆNon-Uniform Memory Accessï¼Œéå‡åŒ€å†…å­˜è®¿é—®æ¶æ„ï¼‰ï¼‰ devicesï¼šæ§åˆ¶ cgroup ä¸­è¿›ç¨‹çš„ CPU å ç”¨ freezerï¼šç”¨äºæŒ‚èµ·ï¼ˆsuspendï¼‰å’Œæ¢å¤ï¼ˆresumeï¼‰cgroupä¸­çš„è¿›ç¨‹ memoryï¼šç”¨äºæ§åˆ¶ cgroup ä¸­è¿›ç¨‹çš„å†…å­˜å ç”¨ net_clsï¼šç”¨äºå°† cgroup ä¸­è¿›ç¨‹äº§ç”Ÿçš„ç½‘ç»œåŒ…åˆ†ç±»ï¼Œä»¥ä¾¿ Linux çš„ tcï¼ˆtraffic controllerï¼‰å¯ä»¥æ ¹æ®åˆ†ç±»åŒºåˆ†å‡ºæ¥è‡ªæŸä¸ª cgroup çš„åŒ…å¹¶åšé™åˆ¶å’Œç›‘æ§ net_prioï¼šè®¾ç½® cgroup ä¸­è¿›ç¨‹äº§ç”Ÿçš„ç½‘ç»œæµé‡çš„ä¼˜å…ˆçº§ nsï¼šç®¡ç† cgroup ä¸­åˆ›å»ºçš„ Namespace ä¸­çš„æ–°çš„ cgroup ä¹Ÿå°±æ˜¯æ¯ä¸ª subsystem ä¼šå…³è”åˆ°å®šä¹‰äº†ç›¸åº”é™åˆ¶çš„ cgroup ä¸Šï¼Œå¹¶å¯¹è¿™ä¸ª cgroup ä¸­çš„è¿›ç¨‹åšç›¸åº”çš„é™åˆ¶å’Œæ§åˆ¶\nå¦‚ä½•æŸ¥çœ‹å½“å‰å†…æ ¸æ”¯æŒå“ªäº› subsystem ï¼Ÿ\né¦–å…ˆï¼Œå®‰è£… cgroup ï¼ˆapt-get install cgroup-binï¼‰,ç„¶åé€šè¿‡ lssubsys è¿›è¡ŒæŸ¥çœ‹ï¼ˆlssubsys -aï¼‰\nhierarchyï¼šæŠŠä¸€ç»„ cgroup ä¸²æˆä¸€ä¸ªæ ‘çŠ¶çš„ç»“æ„ï¼Œä¸€ä¸ªè¿™æ ·çš„æ ‘ï¼Œä¾¿æ˜¯ä¸€ä¸ª hierarchyï¼ˆç­‰çº§åˆ¶åº¦ï¼‰ã€‚é€šè¿‡è¿™ç§æ ‘çŠ¶ç»“æ„ï¼ŒCgroups å¯ä»¥åšåˆ°ç»§æ‰¿ã€‚å¦‚ï¼šç³»ç»Ÿå¯¹ä¸€ç»„å®šæ—¶çš„ä»»åŠ¡è¿›ç¨‹é€šè¿‡ cgroup1 é™åˆ¶äº† CPUçš„åˆ©ç”¨ç‡ï¼Œç„¶åå…¶ä¸­æœ‰ä¸ªå®šæ—¶ dump æ—¥å¿—çš„è¿›ç¨‹è¿˜éœ€è¦é™åˆ¶ç£ç›˜ IOï¼Œä¸ºäº†é¿å…å½±å“åˆ°ä¹‹åçš„å…¶å®ƒè¿›ç¨‹ï¼Œå°±éœ€è¦åˆ›å»º cgroup2ï¼Œä½¿å…¶ç»§æ‰¿ cgroup1 çš„é™åˆ¶CPUï¼Œè€Œä¸åŸºç¡€é™åˆ¶ ç£ç›˜IO\nä¸‰ä¸ªç»„ä»¶çš„ç›¸äº’å…³ç³»\nå¾ˆæ˜æ˜¾ Cgroups æ˜¯ä¾é ç€ä¸‰ä¸ªç»„ä»¶ç›¸äº’åä½œå®ç°çš„ï¼Œé‚£ä¹ˆä¸‰ä¸ªç»„ä»¶çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ\nä¸€ä¸ªç³»ç»Ÿåœ¨åˆ›å»ºäº† hierarchy ä¹‹åï¼Œç³»ç»Ÿçš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šåŠ å…¥è¿™ä¸ª hierarchy çš„ cgroup æ ¹èŠ‚ç‚¹ï¼ˆhierarchy é»˜è®¤åˆ›å»ºçš„ï¼‰ ä¸€ä¸ª subsystem åªèƒ½èµ‹å€¼åˆ°ä¸€ä¸ª hierarchy ä¸Š ä¸€ä¸ª hierarchy ä¸Šå¯ä»¥è¢«èµ‹å€¼å¤šä¸ª subsystem ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä½œä¸ºå¤šä¸ª cgroup çš„æˆå‘˜ï¼Œä½†æ˜¯è¿™äº› cgroup å¿…é¡»åœ¨ä¸åŒçš„ hierarchy ä¸Š å½“ä¸€ä¸ªè¿›ç¨‹ fork ä¸€ä¸ªå­è¿›ç¨‹åï¼Œå­è¿›ç¨‹é»˜è®¤è·Ÿçˆ¶è¿›ç¨‹åœ¨åŒä¸€ä¸ª cgroupï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä¸åŒ Kernel æ¥å£ æˆ‘ä»¬è¦é…ç½® Cgroupsï¼Œéœ€è¦è°ƒç”¨ Kernel çš„æ¥å£æ‰è¡Œã€‚ä¸ºäº†ä½¿å…¶ Cgroupsçš„é…ç½®æ›´ç›´è§‚ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ªè™šæ‹Ÿçš„æ ‘çŠ¶æ–‡ä»¶ç³»ç»Ÿé…ç½® Cgroups çš„ï¼Œé€šè¿‡å±‚çº§çš„ç›®å½•è™šæ‹Ÿå‡º cgroup æ ‘\nåˆ›å»ºå¹¶æŒ‚è½½ä¸€ä¸ª hierarchyï¼ˆcgroupæ ‘ï¼‰\n1 2 3 4 mkdir cgroup-test # åˆ›å»ºæŒ‚è½½ç‚¹ sudo mount -t cgroup -o none,name=cgroup-test cgroup-test ./cgroup-test # æŒ‚è½½ä¸€ä¸ªhierarchy ls ./cgroup-test # è¾“å‡ºæ ¹èŠ‚ç‚¹çš„é…ç½® # è¾“å‡ºï¼šcgroup.clone_children cgroup.procs cgroup.sane _behavior notify_on_release release_agent tasks cgroup.clone_childrenï¼šcpusetï¼ˆè¿›ç¨‹ä½¿ç”¨CPUå’Œå†…å­˜ï¼‰çš„ subsystem ä¼šè¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¦‚æœè¿™ä¸ªå€¼æ˜¯1ï¼ˆé»˜è®¤æ˜¯0ï¼‰ï¼Œå­cgroupå°±ä¼šç»§æ‰¿çˆ¶çš„ cpuset é…ç½® cgroup.procsï¼šæ ‘ä¸­å½“å‰èŠ‚ç‚¹ cgroup ä¸­çš„è¿›ç¨‹ç»„IDï¼Œå½“å‰ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå³æ–‡ä»¶ä¸­ä¼šæœ‰ç°åœ¨ç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹ç»„çš„ID notify_on_release å’Œ release_agent ä¼šä¸€èµ·ä½¿ç”¨ã€‚notify_on_releaseæ ‡è¯†å½“å‰çš„cgroupä¸­çš„æœ€åä¸€ä¸ªè¿›ç¨‹é€€å‡ºåï¼Œæ˜¯å¦æ‰§è¡Œ release_agentã€‚release_agentåˆ™æ˜¯ä¸€ä¸ªè·¯å¾„ï¼Œä¼šæ‰§è¡Œå…¶å¯¹åº”çš„æ–‡ä»¶ï¼Œé€šå¸¸ç”¨æ¥æ¸…ç†ä¸å†ä½¿ç”¨çš„ cgroup tasksï¼šæ ‡è¯†è¯¥ cgroup ä¸‹çš„è¿›ç¨‹ IDï¼Œå¦‚æœæŠŠä¸€ä¸ªè¿›ç¨‹IDå†™åˆ° tasks å†™åˆ°æ–‡ä»¶ä¸­ï¼Œä¾¿ä¼šä½¿ç›¸åº”çš„è¿›ç¨‹åŠ å…¥åˆ°å¯¹åº”çš„ cgroupä¸­ åœ¨åˆšåˆšåˆ›å»ºå¥½çš„ hierarchy ä¸Šæ‰©å±•ä¸¤ä¸ªå­ cgroup\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 cd cgroup-test sudo mkdir cgroup-1 # åˆ›å»ºå­ cgroup 'cgroup-1' sudo mkdir cgroup-2 # åˆ›å»ºå­ cgroup 'cgroup-2' tree # è¾“å‡ºï¼š :\u003c",
  "wordCount" : "7321",
  "inLanguage": "en",
  "datePublished": "2022-03-10T18:12:37Z",
  "dateModified": "2022-03-10T18:12:37Z",
  "author":{
    "@type": "Person",
    "name": "Noodles2hg"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/z-anshun/en/posts/read/%E6%89%8B%E6%90%93docker/%E5%9F%BA%E7%A1%80%E6%8A%80%E6%9C%AF/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Noodles2hgçš„åšå®¢",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/z-anshun/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/z-anshun/en/" accesskey="h" title="Noodles2hg&#39;s Blog (Alt + H)">
                <img src="https://www.sulvblog.cn/Q.gif" alt="" aria-label="logo"
                    height="35">Noodles2hg&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/z-anshun/en/search/" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/z-anshun/en/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/z-anshun/en/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/z-anshun/en/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/z-anshun/en/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/z-anshun/en/links" title="ğŸ¤å‹é“¾">
                    <span>ğŸ¤å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/z-anshun/en/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/z-anshun/en/posts/">Posts</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/z-anshun/en/posts/read/">ğŸ“•é˜…è¯»</a></div>
    <h1 class="post-title entry-hint-parent">
      åŸºç¡€æŠ€æœ¯
    </h1>
    <div class="post-meta"><span title='2022-03-10 18:12:37 +0000 UTC'>2022-03-10</span>&nbsp;Â·&nbsp;15 min&nbsp;Â·&nbsp;Noodles2hg

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#docker" aria-label="Docker">Docker</a></li>
                <li>
                    <a href="#linux-namespace" aria-label="Linux Namespace">Linux Namespace</a><ul>
                        
                <li>
                    <a href="#%e6%a6%82%e5%bf%b5" aria-label="æ¦‚å¿µ">æ¦‚å¿µ</a></li>
                <li>
                    <a href="#uts-namespace" aria-label="UTS Namespace">UTS Namespace</a></li>
                <li>
                    <a href="#ipc-namespace" aria-label="IPC Namespace">IPC Namespace</a></li>
                <li>
                    <a href="#pid-namespace" aria-label="PID Namespace">PID Namespace</a></li>
                <li>
                    <a href="#mount-namespace" aria-label="Mount Namespace">Mount Namespace</a></li>
                <li>
                    <a href="#user-namespace" aria-label="User Namespace">User Namespace</a></li>
                <li>
                    <a href="#network-namespace" aria-label="Network Namespace">Network Namespace</a></li></ul>
                </li>
                <li>
                    <a href="#linux-cgroups" aria-label="Linux Cgroups">Linux Cgroups</a><ul>
                        
                <li>
                    <a href="#kernel-%e6%8e%a5%e5%8f%a3" aria-label="Kernel æ¥å£">Kernel æ¥å£</a></li>
                <li>
                    <a href="#docker-%e4%bd%bf%e7%94%a8-groups" aria-label="Docker ä½¿ç”¨ Groups">Docker ä½¿ç”¨ Groups</a></li>
                <li>
                    <a href="#go-%e5%ae%9e%e7%8e%b0%e9%80%9a%e8%bf%87-cgroup-%e9%99%90%e5%88%b6%e5%ae%b9%e5%99%a8%e8%b5%84%e6%ba%90" aria-label="Go å®ç°é€šè¿‡ cgroup é™åˆ¶å®¹å™¨èµ„æº">Go å®ç°é€šè¿‡ cgroup é™åˆ¶å®¹å™¨èµ„æº</a></li></ul>
                </li>
                <li>
                    <a href="#union-file-system" aria-label="Union File System">Union File System</a><ul>
                        
                <li>
                    <a href="#aufs" aria-label="AUFS">AUFS</a><ul>
                        
                <li>
                    <a href="#image-layer%e5%92%8caufs" aria-label="image layerå’ŒAUFS">image layerå’ŒAUFS</a></li>
                <li>
                    <a href="#container-layer-%e5%92%8c-aufs" aria-label="container layer å’Œ AUFS">container layer å’Œ AUFS</a></li>
                <li>
                    <a href="#%e6%89%8b%e5%8a%a8%e5%ae%9e%e7%8e%b0-aufs" aria-label="æ‰‹åŠ¨å®ç° AUFS">æ‰‹åŠ¨å®ç° AUFS</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="docker">Docker<a hidden class="anchor" aria-hidden="true" href="#docker">#</a></h1>
<blockquote>
<p>ä»€ä¹ˆæ˜¯dockerï¼Ÿ</p>
</blockquote>
<p>ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå°†åº”ç”¨æ‰“åŒ…ä¸ºé•œåƒï¼Œå¹¶ä»¥å®¹å™¨æ–¹å¼è¿è¡Œ</p>
<p>Docker å®¹å™¨å…·æœ‰ä¸‹é¢ä¸‰ä¸ªç‰¹ç‚¹ï¼š</p>
<ul>
<li>è½»é‡çº§ï¼šå…±äº«å†…æ ¸ï¼Œå¹¶ä¸”å› ä¸ºé•œåƒä»¥åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿæ„é€ ï¼Œè¿™ä½¿å¾—å®ƒä»¬å¯ä»¥å…±äº«ç›¸åŒçš„æ–‡ä»¶ï¼Œä½¿å¾—ç£ç›˜ä½¿ç”¨ç‡å’Œé•œåƒä¸‹è½½é€Ÿåº¦éƒ½æé«˜</li>
<li>å¼€æ”¾ï¼š</li>
<li>å®‰å…¨ï¼šéš”ç¦»</li>
</ul>
<h1 id="linux-namespace">Linux Namespace<a hidden class="anchor" aria-hidden="true" href="#linux-namespace">#</a></h1>
<h2 id="æ¦‚å¿µ">æ¦‚å¿µ<a hidden class="anchor" aria-hidden="true" href="#æ¦‚å¿µ">#</a></h2>
<p>Linux Namespace æ˜¯ Kernel çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå¯ä»¥éš”ç¦»ä¸€ç³»åˆ—çš„ç³»ç»Ÿèµ„æºï¼Œæ¯”å¦‚ï¼šPIDã€User IDã€Networkã€è¿›ç¨‹èµ„æºç­‰ã€‚æ—¢ç„¶åŒ…æ‹¬äº†è¿›ç¨‹èµ„æºï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹æ•°ã€ç½‘ç»œæ¥å£ç­‰ï¼Œè¿™é‡Œå°±ä¸èƒ½ä½¿ç”¨<code>chroot</code>å®ç°äº†ï¼ˆæŠŠæ ¹ç›®å½•æ¢æˆæŒ‡å®šçš„ç›®çš„ç›®å½•ï¼‰</p>
<p>å½“å‰ Linux å®ç°çš„ 6 ç§ Namespace</p>
<table>
<thead>
<tr>
<th style="text-align:center">Namespaceç±»å‹</th>
<th style="text-align:center">ç³»ç»Ÿè°ƒç”¨å‚æ•°</th>
<th style="text-align:center">å†…æ ¸ç‰ˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Mount Namespace</td>
<td style="text-align:center">CLONE_NEWNS</td>
<td style="text-align:center">2.4.19</td>
</tr>
<tr>
<td style="text-align:center">UTS Namespcae</td>
<td style="text-align:center">CLONE_NEWUTS</td>
<td style="text-align:center">2.6.19</td>
</tr>
<tr>
<td style="text-align:center">IPC Namespace</td>
<td style="text-align:center">CLONE_NEWIPC</td>
<td style="text-align:center">2.6.19</td>
</tr>
<tr>
<td style="text-align:center">PID Namespcae</td>
<td style="text-align:center">CLONE_NEWPID</td>
<td style="text-align:center">2.6.24</td>
</tr>
<tr>
<td style="text-align:center">Network Namespace</td>
<td style="text-align:center">CLONE_NEWNET</td>
<td style="text-align:center">2.6.29</td>
</tr>
<tr>
<td style="text-align:center">User Namespace</td>
<td style="text-align:center">CLONE_NEWUSER</td>
<td style="text-align:center">3.8</td>
</tr>
</tbody>
</table>
<p>Namespace çš„ API ä¸»è¦ä½¿ç”¨ä¸‹é¢3ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š</p>
<ul>
<li><code>clone()</code>ï¼šåˆ›å»ºæ–°è¿›ç¨‹ï¼Œæ ¹æ®ç³»ç»Ÿè°ƒç”¨å‚æ•°æ¥åˆ¤æ–­å“ªäº›ç±»å‹çš„ Namespace è¢«åˆ›å»ºï¼Œè€Œä¸”å®ƒä»¬çš„å­è¿›ç¨‹ä¹Ÿä¼šè¢«åŒ…å«åˆ°è¿™äº› Namespace ä¸­</li>
<li><code>unshare()</code>ï¼šå°†è¿›ç¨‹ç§»é™¤æŸä¸ª Namespace</li>
<li><code>setns()</code>ï¼šå°†è¿›ç¨‹åŠ å…¥åˆ° Namespace</li>
</ul>
<h2 id="uts-namespace">UTS Namespace<a hidden class="anchor" aria-hidden="true" href="#uts-namespace">#</a></h2>
<p>UNIX Time-sharing System</p>
<p>å…è®¸æ¯ä¸ªå®¹å™¨æ‹¥æœ‰ç‹¬ç«‹çš„ hostname å’Œdomain nameï¼Œä½¿å…¶åœ¨ç½‘ç»œä¸Šå¯è¢«è§†ä½œ<strong>ä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹</strong>è€Œéä¸»æœºä¸Šçš„ä¸€ä¸ªè¿›ç¨‹</p>
<p>ç®€å•çš„ä»£ç å®ç°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> main() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    cmd:=exec.Command(<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// è®¾ç½®å‚æ•°ç³»ç»Ÿï¼Œä½¿ç”¨æ ‡è¯†å»åˆ›å»ºä¸€ä¸ª UTS Namespaceã€‚å¹¶ä¸” GO å°è£…äº†å¯¹ clone() å‡½æ•°çš„è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
</span></span><span style="display:flex;"><span>        Cloneflags: syscall.CLONE_NEWUTS,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>    cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>    cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := cmd.Run(); err!=<span style="color:#fff;font-weight:bold">nil</span>{
</span></span><span style="display:flex;"><span>        log.Fatal(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯åŠ¨åï¼ŒéªŒè¯çˆ¶å­è¿›ç¨‹ä¸åœ¨åŒä¸€ä¸ªUST Namespaceï¼š</p>
<ul>
<li>
<p>ä½¿ç”¨<code>pstree -pl</code>æŸ¥çœ‹çˆ¶å­è¿›ç¨‹çš„IDï¼Œç„¶åä½¿ç”¨<code>readlink /proc/$PID/ns/uts</code>éªŒè¯å¾—åˆ°çˆ¶å­è¿›ç¨‹ä¸åœ¨åŒä¸€ä¸ªUTS Namespace</p>
</li>
<li>
<p>ä¿®æ”¹å½“å‰å¯åŠ¨çš„shçš„hostnameï¼ˆ<code>hostname -b $name</code>ï¼‰ï¼Œä¹Ÿä¸ä¼šå½±å“å¤–éƒ¨</p>
</li>
</ul>
<h2 id="ipc-namespace">IPC Namespace<a hidden class="anchor" aria-hidden="true" href="#ipc-namespace">#</a></h2>
<p>ç”¨æ¥éš”ç¦» System V IPC å’Œ POSIX message queuesã€‚æ¯ä¸€ä¸ª IPC Namespace éƒ½æœ‰è‡ªå·±çš„ System V IPC å’Œ POSIX message queue</p>
<p>ä»£ç å®ç°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> main() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    cmd:=exec.Command(<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
</span></span><span style="display:flex;"><span>        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>    cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>    cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := cmd.Run(); err!=<span style="color:#fff;font-weight:bold">nil</span>{
</span></span><span style="display:flex;"><span>        log.Fatal(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç›¸å½“äºï¼Œç°åœ¨å¤šåŠ äº†ä¸€ä¸ªæ ‡è¯†ï¼Œè¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›åˆ›å»º IPC Namespace</p>
<p>éªŒè¯ï¼š</p>
<p>é¦–å…ˆï¼Œåœ¨ä¸»æœºï¼Œä½¿ç”¨<code>ipcs</code>æŸ¥çœ‹ï¼Œç„¶å<code>ipcmk</code>åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå¯åŠ¨ï¼Œå‘ç°æ–°åˆ›å»ºçš„shä¸­ï¼ŒæŸ¥æ‰¾ä¸åˆ°è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå³å®ç° IPC å‘½ä»¤ç©ºé—´éš”ç¦»</p>
<h2 id="pid-namespace">PID Namespace<a hidden class="anchor" aria-hidden="true" href="#pid-namespace">#</a></h2>
<p>éš”ç¦»è¿›ç¨‹ IDï¼Œå³åŒä¸€ä¸ªè¿›ç¨‹åœ¨ä¸åŒçš„ PID Namespace é‡Œå¯ä»¥æ‹¥æœ‰ä¸åŒçš„ PIDã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯åœ¨å®¹å™¨å†…å¤–æŸ¥çœ‹åŒä¸€ä¸ªè¿›ç¨‹çš„ IDä¸åŒï¼Œæ¯”å¦‚ï¼Œå®¹å™¨å†… PIDä¸º1ï¼Œä½†æ˜¯åœ¨å®¹å™¨å¤–ï¼Œå´ä¸ä¸€æ ·ã€‚</p>
<p>ä»£ç å®ç°ï¼šæ·»åŠ  <code>syscall.CLONE_NEWPID</code>æ ‡è¯†å³å¯</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> main() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    cmd:=exec.Command(<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
</span></span><span style="display:flex;"><span>        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>    cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>    cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := cmd.Run(); err!=<span style="color:#fff;font-weight:bold">nil</span>{
</span></span><span style="display:flex;"><span>        log.Fatal(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯ï¼š</p>
<p>é¦–å…ˆï¼Œè¿è¡ŒGoæ–‡ä»¶ï¼Œæ‰§è¡Œ<code>echo $$</code>æ‰“å°å‡ºå½“å‰ PID ä¸º 1ï¼Œ</p>
<p>ç„¶åï¼Œåœ¨å¤–éƒ¨ä½¿ç”¨ <code>pstree -pl</code> æŸ¥çœ‹è¿›ç¨‹æ ‘ã€‚å‘ç° GO å¯¹åº”çš„è¿›ç¨‹ä¸ä¸º 1ï¼Œä¹Ÿå°±æ˜¯åœ¨å®¹å™¨å†…å¤–çš„ PIDä¸åŒï¼Œå®ç°äº† PID Namespace</p>
<h2 id="mount-namespace">Mount Namespace<a hidden class="anchor" aria-hidden="true" href="#mount-namespace">#</a></h2>
<p>éš”ç¦»å„è¿›ç¨‹çœ‹åˆ°çš„æŒ‚è½½ç‚¹è§†å›¾ï¼Œå³åœ¨ä¸åŒå®¹å™¨ä¸­çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡æ˜¯ä¸åŒçš„ã€‚è€Œä¸”ï¼Œåœ¨ä¸åŒçš„å®¹å™¨ä¸­è°ƒç”¨<code>mount()</code>å’Œ<code>unmount</code>åªä¼šå½±å“å½“å‰æ–‡ä»¶ç³»ç»Ÿï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒï¼Œæˆ–è€…å…¨å±€ã€‚</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆ Mount Namespace çš„è°ƒç”¨å‚æ•°ä¸º CLONE_NEWNSï¼Œè€Œä¸æ˜¯è·Ÿå…¶å®ƒä¸€æ ·ï¼Œå¦‚ CLONE_NEWPID?</p>
</blockquote>
<p>å› ä¸ºå®ƒæ˜¯Linuxå®ç°çš„ç¬¬ä¸€ä¸ªNamespaceï¼Œå› æ­¤ä¸º NEWNSï¼ˆNew Namespaceç¼©å†™ï¼‰ã€‚è€Œä¸”å½“æ—¶æ²¡å¹¶æœªæƒ³åˆ°åé¢è¿˜æœ‰è®¸å¤š NamespaceåŠ å…¥</p>
<p>ä»£ç å®ç°ï¼Œè·Ÿä¸Šé¢ç±»ä¼¼ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> main() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    cmd:=exec.Command(<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
</span></span><span style="display:flex;"><span>        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>    cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>    cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := cmd.Run(); err!=<span style="color:#fff;font-weight:bold">nil</span>{
</span></span><span style="display:flex;"><span>        log.Fatal(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    os.Exit(-<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯ï¼š</p>
<p>è¿è¡Œä»£ç ï¼Œæ‰§è¡Œ<code>ls /proc</code>æŸ¥çœ‹å†…æ ¸å’Œå†…æ ¸æ¨¡å—çš„ä¿¡æ¯ã€‚</p>
<p>ç„¶åï¼Œæ‰§è¡Œ<code>mount -t proc proc /proc</code>ï¼Œå³ä½¿è®²å½“å‰ Namespace çš„ procæŒ‚è½½åˆ° /procï¼Œ</p>
<p>æ¥ç€ï¼Œæ‰§è¡Œ<code>ls /proc</code>ï¼Œè·Ÿä¸€å¼€å§‹çš„ä¿¡æ¯ä¸åŒï¼Œå› ä¸ºä¸€å¼€å§‹æœªæŒ‚è½½ï¼Œçœ‹çš„è¿˜æ˜¯å®¿ä¸»æœºçš„ï¼Œè€Œç°åœ¨æŒ‚è½½åï¼Œçœ‹åˆ°å°±æ˜¯ Namespace é‡Œçš„</p>
<p>æœ€åï¼Œæ‰§è¡Œ<code>ps -ef</code>ï¼Œçœ‹åˆ°shè¿›ç¨‹çš„IDä¸º1ï¼Œå³ä¸å¤–éƒ¨å®ç°éš”ç¦»ï¼Œmountå¹¶æ²¡æœ‰å½±å“åˆ°å¤–éƒ¨ï¼ˆ<code>ps</code>å‘½ä»¤ä¼šä½¿ç”¨/proc ä¸‹çš„å†…å®¹ï¼‰</p>
<h2 id="user-namespace">User Namespace<a hidden class="anchor" aria-hidden="true" href="#user-namespace">#</a></h2>
<p>éš”ç¦»ç”¨æˆ·çš„ç”¨æˆ·ç»„IDã€‚ä¹Ÿå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„ User ID å’Œ Group IDåœ¨User Namespace å†…å¤–æ˜¯ä¸åŒçš„ã€‚è¾ƒä¸ºå¸¸ç”¨çš„å°±æ˜¯å®¿ä¸»æœºä¸Šä¸€ä¸ªé root ç”¨æˆ·è¿è¡Œåˆ›å»ºä¸€ä¸ª User Namespaceï¼Œç„¶ååœ¨User Namespace é‡Œå´æ˜ å°„ä¸º root ç”¨æˆ·ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥è¿›ç¨‹åœ¨ User Namespaceä¸­æœ‰rootæƒé™ï¼Œä½†åœ¨å¤–é¢å´æ²¡æœ‰rootæƒé™ã€‚</p>
<p>ä» Linux Kernel3.8 å¼€å§‹ï¼Œérootè¿›ç¨‹ä¹Ÿå¯ä»¥åˆ›å»º User Namespaceã€‚</p>
<p>ä»£ç å®ç°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0ff;font-weight:bold">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> main() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    cmd:=exec.Command(<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
</span></span><span style="display:flex;"><span>        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS | syscall.CLONE_NEWUSER,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cmd.SysProcAttr.Credential = &amp;syscall.Credential{Uid:<span style="color:#fff;font-weight:bold">uint32</span>(<span style="color:#ff0;font-weight:bold">1</span>),Gid:<span style="color:#fff;font-weight:bold">uint32</span>(<span style="color:#ff0;font-weight:bold">1</span>)}
</span></span><span style="display:flex;"><span>    cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>    cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>    cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := cmd.Run(); err!=<span style="color:#fff;font-weight:bold">nil</span>{
</span></span><span style="display:flex;"><span>        log.Fatal(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯ï¼š</p>
<p>é¦–å…ˆï¼Œä½¿ç”¨ <code>id</code> æŸ¥çœ‹å½“å‰æ˜¯å¦ä¸º root ç”¨æˆ·ï¼Œç„¶åè¿è¡Œ<code>go run main.go</code></p>
<p>ç„¶åï¼Œæ‰§è¡Œ<code>id</code> æŸ¥çœ‹ Namespace ä¸­çš„ä¿¡æ¯ï¼Œå…¶UIDè·Ÿåˆšæ‰ä¸åŒï¼Œå³è¯æ˜User Namespace ç”Ÿæ•ˆ</p>
<h2 id="network-namespace">Network Namespace<a hidden class="anchor" aria-hidden="true" href="#network-namespace">#</a></h2>
<p>ç”¨æ¥éš”ç¦»ç½‘ç»œè®¾å¤‡ã€IP åœ°å€ç«¯å£ç­‰ç½‘ç»œæ ˆçš„Namespaceã€‚</p>
<p>ä½¿æ¯ä¸ªå®¹æ˜“æ‹¥æœ‰è‡ªå·±çš„ç½‘ç»œè®¾å¤‡ï¼ˆè™šæ‹Ÿï¼‰ï¼Œè€Œä¸”å®¹å™¨å†…å¯ä»¥è¿›è¡Œç«¯å£ç»‘å®šï¼Œæ¯ä¸ªNamespaceä¸­ä¹Ÿä¸ä¼šå†²çªï¼ˆå³ä¸åŒå®¹å™¨ä¹‹é—´å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç«¯å£ï¼‰</p>
<p>ä»£ç å®ç°ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> main() {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">// æŒ‡å®šè¢« fork å‡ºæ¥çš„æ–°è¿›ç¨‹å†…çš„åˆå§‹å‘½ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    cmd:=exec.Command(<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
</span></span><span style="display:flex;"><span>        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS | syscall.CLONE_NEWUSER | syscall.CLONE_NEWNET,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    cmd.SysProcAttr.Credential = &amp;syscall.Credential{Uid:<span style="color:#fff;font-weight:bold">uint32</span>(<span style="color:#ff0;font-weight:bold">1</span>),Gid:<span style="color:#fff;font-weight:bold">uint32</span>(<span style="color:#ff0;font-weight:bold">1</span>)}
</span></span><span style="display:flex;"><span>    cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>    cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>    cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> err := cmd.Run(); err!=<span style="color:#fff;font-weight:bold">nil</span>{
</span></span><span style="display:flex;"><span>        log.Fatal(err)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆï¼Œä½¿ç”¨<code>ifconfig</code>æŸ¥çœ‹å½“å‰çš„ç½‘ç»œè®¾å¤‡ï¼Œå‘ç°æœ‰loã€eth0ã€eth1ç­‰</p>
<p>ç„¶åï¼Œ<code>go run main.go</code>ï¼Œå†åœ¨Namespaceä¸­è¿è¡Œ<code>ifconfig</code>ï¼ŒæŸ¥çœ‹ä»€ä¹ˆç½‘ç»œè®¾å¤‡éƒ½æ²¡æœ‰ï¼ˆå› ä¸ºè¿™é‡Œå¹¶æ²¡æœ‰é…ç½®ç½‘æ¡¥ï¼‰</p>
<h1 id="linux-cgroups">Linux Cgroups<a hidden class="anchor" aria-hidden="true" href="#linux-cgroups">#</a></h1>
<p>æ§åˆ¶ç»„ï¼Œç¡®ä¿æ¯ä¸ªå®¹å™¨æ‰€å æœ‰çš„èµ„æºï¼Œè¿™æ ·<strong>ç¡®ä¿äº†å½“å®¹å™¨å†…çš„èµ„æºä½¿ç”¨äº§ç”Ÿå‹åŠ›æ—¶ä¸ä¼šè¿ç´¯ä¸»æœºç³»ç»Ÿ</strong>ã€‚ä¹Ÿå°±èƒ½é¢„é˜² DOOSæ”»å‡»</p>
<p>Cgroups ä¸­çš„ä¸‰ä¸ªç»„ä»¶ï¼š</p>
<ul>
<li>
<p>cgroupï¼šä¸€ç§å¯¹è¿›ç¨‹åˆ†ç»„ç®¡ç†çš„æœºåˆ¶ï¼Œä¸€ä¸ªcgroupå°±åŒ…å«äº†ä¸€ç»„è¿›ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å…¶é…ç½® Linux subsystem çš„å„ç§å‚æ•°é…ç½®ï¼Œå³è®²ä¸€ç»„è¿›ç¨‹å’Œä¸€ç»„ subsystem çš„ç³»ç»Ÿå‚æ•°å…³è”èµ·æ¥</p>
</li>
<li>
<p>subsystemï¼šä¸€ç»„èµ„æºæ§åˆ¶çš„æ¿å—ï¼ŒåŒ…å«å¦‚ä¸‹å‡ é¡¹:</p>
<ul>
<li>blkioï¼šè®¾ç½®å¯¹å—è®¾å¤‡ï¼ˆæ¯”å¦‚ç¡¬ç›˜ï¼‰è¾“å…¥è¾“å‡ºçš„è®¿é—®æ§åˆ¶</li>
<li>cpuï¼šè®¾ç½®cgroupä¸­è¿›ç¨‹çš„ CPU è¢«è°ƒåº¦çš„ç­–ç•¥</li>
<li>cpuacctï¼šå¯ä»¥ç»Ÿè®¡ cgroup ä¸­è¿›ç¨‹çš„CPUå ç”¨</li>
<li>cpusetï¼šåœ¨å¤šæ ¸æœºå™¨ä¸Šè®¾ç½® cgroup ä¸­è¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„ CPU å’Œå†…å­˜ï¼ˆæ­¤å¤„å†…å­˜ä»…ç”¨äº NUMA æ¶æ„ï¼ˆNon-Uniform Memory Accessï¼Œéå‡åŒ€å†…å­˜è®¿é—®æ¶æ„ï¼‰ï¼‰</li>
<li>devicesï¼šæ§åˆ¶ cgroup ä¸­è¿›ç¨‹çš„ CPU å ç”¨</li>
<li>freezerï¼šç”¨äºæŒ‚èµ·ï¼ˆsuspendï¼‰å’Œæ¢å¤ï¼ˆresumeï¼‰cgroupä¸­çš„è¿›ç¨‹</li>
<li>memoryï¼šç”¨äºæ§åˆ¶ cgroup ä¸­è¿›ç¨‹çš„å†…å­˜å ç”¨</li>
<li>net_clsï¼šç”¨äºå°† cgroup ä¸­è¿›ç¨‹äº§ç”Ÿçš„ç½‘ç»œåŒ…åˆ†ç±»ï¼Œä»¥ä¾¿ Linux çš„ tcï¼ˆtraffic controllerï¼‰å¯ä»¥æ ¹æ®åˆ†ç±»åŒºåˆ†å‡ºæ¥è‡ªæŸä¸ª cgroup çš„åŒ…å¹¶åšé™åˆ¶å’Œç›‘æ§</li>
<li>net_prioï¼šè®¾ç½® cgroup ä¸­è¿›ç¨‹äº§ç”Ÿçš„ç½‘ç»œæµé‡çš„ä¼˜å…ˆçº§</li>
<li>nsï¼šç®¡ç† cgroup ä¸­åˆ›å»ºçš„ Namespace ä¸­çš„æ–°çš„ cgroup</li>
</ul>
<p>ä¹Ÿå°±æ˜¯æ¯ä¸ª subsystem ä¼šå…³è”åˆ°å®šä¹‰äº†ç›¸åº”é™åˆ¶çš„ cgroup ä¸Šï¼Œå¹¶å¯¹è¿™ä¸ª cgroup ä¸­çš„è¿›ç¨‹åšç›¸åº”çš„é™åˆ¶å’Œæ§åˆ¶</p>
<blockquote>
<p>å¦‚ä½•æŸ¥çœ‹å½“å‰å†…æ ¸æ”¯æŒå“ªäº› subsystem ï¼Ÿ</p>
</blockquote>
<p>é¦–å…ˆï¼Œå®‰è£… cgroup ï¼ˆ<code>apt-get install cgroup-bin</code>ï¼‰,ç„¶åé€šè¿‡ lssubsys è¿›è¡ŒæŸ¥çœ‹ï¼ˆ<code>lssubsys -a</code>ï¼‰</p>
</li>
<li>
<p>hierarchyï¼šæŠŠä¸€ç»„ cgroup ä¸²æˆä¸€ä¸ªæ ‘çŠ¶çš„ç»“æ„ï¼Œä¸€ä¸ªè¿™æ ·çš„æ ‘ï¼Œä¾¿æ˜¯ä¸€ä¸ª hierarchyï¼ˆç­‰çº§åˆ¶åº¦ï¼‰ã€‚é€šè¿‡è¿™ç§æ ‘çŠ¶ç»“æ„ï¼ŒCgroups å¯ä»¥åšåˆ°ç»§æ‰¿ã€‚å¦‚ï¼šç³»ç»Ÿå¯¹ä¸€ç»„å®šæ—¶çš„ä»»åŠ¡è¿›ç¨‹é€šè¿‡ cgroup1 é™åˆ¶äº† CPUçš„åˆ©ç”¨ç‡ï¼Œç„¶åå…¶ä¸­æœ‰ä¸ªå®šæ—¶ dump æ—¥å¿—çš„è¿›ç¨‹è¿˜éœ€è¦é™åˆ¶ç£ç›˜ IOï¼Œä¸ºäº†é¿å…å½±å“åˆ°ä¹‹åçš„å…¶å®ƒè¿›ç¨‹ï¼Œå°±éœ€è¦åˆ›å»º cgroup2ï¼Œä½¿å…¶ç»§æ‰¿ cgroup1 çš„é™åˆ¶CPUï¼Œè€Œä¸åŸºç¡€é™åˆ¶ ç£ç›˜IO</p>
</li>
</ul>
<p><strong>ä¸‰ä¸ªç»„ä»¶çš„ç›¸äº’å…³ç³»</strong></p>
<blockquote>
<p>å¾ˆæ˜æ˜¾ Cgroups æ˜¯ä¾é ç€ä¸‰ä¸ªç»„ä»¶ç›¸äº’åä½œå®ç°çš„ï¼Œé‚£ä¹ˆä¸‰ä¸ªç»„ä»¶çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</blockquote>
<ol>
<li>ä¸€ä¸ªç³»ç»Ÿåœ¨åˆ›å»ºäº† hierarchy ä¹‹åï¼Œç³»ç»Ÿçš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šåŠ å…¥è¿™ä¸ª hierarchy çš„ cgroup æ ¹èŠ‚ç‚¹ï¼ˆhierarchy é»˜è®¤åˆ›å»ºçš„ï¼‰</li>
<li>ä¸€ä¸ª subsystem åªèƒ½èµ‹å€¼åˆ°ä¸€ä¸ª hierarchy ä¸Š</li>
<li>ä¸€ä¸ª hierarchy ä¸Šå¯ä»¥è¢«èµ‹å€¼å¤šä¸ª subsystem</li>
<li>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä½œä¸ºå¤šä¸ª cgroup çš„æˆå‘˜ï¼Œä½†æ˜¯è¿™äº› cgroup å¿…é¡»åœ¨ä¸åŒçš„ hierarchy ä¸Š</li>
<li>å½“ä¸€ä¸ªè¿›ç¨‹ fork ä¸€ä¸ªå­è¿›ç¨‹åï¼Œå­è¿›ç¨‹é»˜è®¤è·Ÿçˆ¶è¿›ç¨‹åœ¨åŒä¸€ä¸ª cgroupï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä¸åŒ</li>
</ol>
<h2 id="kernel-æ¥å£">Kernel æ¥å£<a hidden class="anchor" aria-hidden="true" href="#kernel-æ¥å£">#</a></h2>
<p>æˆ‘ä»¬è¦é…ç½® Cgroupsï¼Œéœ€è¦è°ƒç”¨ Kernel çš„æ¥å£æ‰è¡Œã€‚ä¸ºäº†ä½¿å…¶ Cgroupsçš„é…ç½®æ›´ç›´è§‚ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ªè™šæ‹Ÿçš„æ ‘çŠ¶æ–‡ä»¶ç³»ç»Ÿé…ç½® Cgroups çš„ï¼Œé€šè¿‡å±‚çº§çš„ç›®å½•è™šæ‹Ÿå‡º cgroup æ ‘</p>
<ol>
<li>
<p>åˆ›å»ºå¹¶æŒ‚è½½ä¸€ä¸ª hierarchyï¼ˆcgroupæ ‘ï¼‰</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mkdir cgroup-test <span style="color:#007f7f"># åˆ›å»ºæŒ‚è½½ç‚¹</span>
</span></span><span style="display:flex;"><span>sudo mount -t cgroup -o none,name=cgroup-test cgroup-test ./cgroup-test <span style="color:#007f7f"># æŒ‚è½½ä¸€ä¸ªhierarchy</span>
</span></span><span style="display:flex;"><span>ls ./cgroup-test <span style="color:#007f7f"># è¾“å‡ºæ ¹èŠ‚ç‚¹çš„é…ç½®</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è¾“å‡ºï¼šcgroup.clone_children cgroup.procs cgroup.sane _behavior notify_on_release release_agent tasks</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>cgroup.clone_childrenï¼šcpusetï¼ˆè¿›ç¨‹ä½¿ç”¨CPUå’Œå†…å­˜ï¼‰çš„ subsystem ä¼šè¯»å–è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¦‚æœè¿™ä¸ªå€¼æ˜¯1ï¼ˆé»˜è®¤æ˜¯0ï¼‰ï¼Œå­cgroupå°±ä¼šç»§æ‰¿çˆ¶çš„ cpuset é…ç½®</li>
<li>cgroup.procsï¼šæ ‘ä¸­å½“å‰èŠ‚ç‚¹ cgroup ä¸­çš„è¿›ç¨‹ç»„IDï¼Œå½“å‰ä¸ºæ ¹èŠ‚ç‚¹ï¼Œå³æ–‡ä»¶ä¸­ä¼šæœ‰ç°åœ¨ç³»ç»Ÿä¸­æ‰€æœ‰è¿›ç¨‹ç»„çš„ID</li>
<li>notify_on_release å’Œ release_agent ä¼šä¸€èµ·ä½¿ç”¨ã€‚notify_on_releaseæ ‡è¯†å½“å‰çš„cgroupä¸­çš„æœ€åä¸€ä¸ªè¿›ç¨‹é€€å‡ºåï¼Œæ˜¯å¦æ‰§è¡Œ release_agentã€‚release_agentåˆ™æ˜¯ä¸€ä¸ªè·¯å¾„ï¼Œä¼šæ‰§è¡Œå…¶å¯¹åº”çš„æ–‡ä»¶ï¼Œé€šå¸¸ç”¨æ¥æ¸…ç†ä¸å†ä½¿ç”¨çš„ cgroup</li>
<li>tasksï¼šæ ‡è¯†è¯¥ cgroup ä¸‹çš„è¿›ç¨‹ IDï¼Œå¦‚æœæŠŠä¸€ä¸ªè¿›ç¨‹IDå†™åˆ° tasks å†™åˆ°æ–‡ä»¶ä¸­ï¼Œä¾¿ä¼šä½¿ç›¸åº”çš„è¿›ç¨‹åŠ å…¥åˆ°å¯¹åº”çš„ cgroupä¸­</li>
</ul>
</li>
<li>
<p>åœ¨åˆšåˆšåˆ›å»ºå¥½çš„ hierarchy ä¸Šæ‰©å±•ä¸¤ä¸ªå­ cgroup</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">cd</span> cgroup-test
</span></span><span style="display:flex;"><span>sudo mkdir cgroup-1 <span style="color:#007f7f"># åˆ›å»ºå­ cgroup &#39;cgroup-1&#39;</span>
</span></span><span style="display:flex;"><span>sudo mkdir cgroup-2 <span style="color:#007f7f"># åˆ›å»ºå­ cgroup &#39;cgroup-2&#39;</span>
</span></span><span style="display:flex;"><span>tree
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># è¾“å‡ºï¼š</span>
</span></span><span style="display:flex;"><span>:<span style="color:#0ff;font-weight:bold">&lt;&lt;eof
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">.
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|-- cgroup-1
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	|-- cgroup.clone_children
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	|-- cgroup.procs
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	|-- notify_on_release
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	â€˜ -- tasks
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|-- cgroup-2
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	|-- cgroup.clone_children
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	|-- cgroup.procs
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	|-- notify_on_release
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|	â€˜ -- tasks
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|-- cgroup.clone_children
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|-- cgroup.procs
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|-- notify_on_release
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">|-- release_agent
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">â€˜ -- tasks
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">eof</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>åœ¨ cgroup ä¸­æ·»åŠ å’Œç§»åŠ¨è¿›ç¨‹</p>
<p>ä¸€ä¸ªè¿›ç¨‹åœ¨ hierarchy æ ‘ä¸Šï¼Œåªèƒ½åœ¨ä¸€ä¸ª cgroup èŠ‚ç‚¹ä¸Šã€‚é»˜è®¤éƒ½åœ¨æ ¹èŠ‚ç‚¹ã€‚è‹¥è¦ç§»åŠ¨åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œå°†å…¶è¿›ç¨‹ ID ç§»åŠ¨åˆ°å¯¹åº” cgroup èŠ‚ç‚¹çš„ tasks æ–‡ä»¶ä¸­å³å¯</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>[cgroup-1] <span style="color:#fff;font-weight:bold">echo</span> $$
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">462</span>
</span></span><span style="display:flex;"><span>[cgroup-1] sudo sh -c <span style="color:#0ff;font-weight:bold">&#34;echo </span>$$<span style="color:#0ff;font-weight:bold"> &gt;&gt; tasks&#34;</span> <span style="color:#007f7f"># å°†åœ¨ç»ˆç«¯çš„è¿›ç¨‹ç§»åŠ¨åˆ° cgroup-1</span>
</span></span><span style="display:flex;"><span>[cgroup-1] cat /proc/462/cgroup
</span></span><span style="display:flex;"><span>13:name=cgroup-test:/cgroup-1 
</span></span><span style="display:flex;"><span>11:perf_event:/ 
</span></span><span style="display:flex;"><span>10:cpu,cpuacct:/user.slice 
</span></span><span style="display:flex;"><span>9:freezer:/ 
</span></span><span style="display:flex;"><span>8:blkio:/user.slice 
</span></span><span style="display:flex;"><span>7:devices:/user.slice 
</span></span><span style="display:flex;"><span>6:cpuset:/ 
</span></span><span style="display:flex;"><span>S:hugetlb:/ 
</span></span><span style="display:flex;"><span>4:pids:/user.slice/user-1000.slice 
</span></span><span style="display:flex;"><span>3:memory:/user.slice 
</span></span><span style="display:flex;"><span>2:net_cls,net_prio:/ 
</span></span><span style="display:flex;"><span>l:name=systemd:/user.slice/user-1000.slice/session-19.scope
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°è¯¥è¿›ç¨‹è¢«åŠ å…¥äº† cgroup-test:/cgroup-1</p>
</li>
<li>
<p>é€šè¿‡ subsystem ç®¡ç† cgroup ä¸­è¿›ç¨‹çš„èµ„æº</p>
<p>ç³»ç»Ÿä¸ºæ¯ä¸ª subsystem åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ hierarchyã€‚å¦‚ memory çš„ hierarchy</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mount | grep memory
</span></span><span style="display:flex;"><span>cgroup on /sys/fs/cgroup/memory <span style="color:#fff;font-weight:bold">type</span> cgroup 
</span></span><span style="display:flex;"><span>(rw,nosuid,nodev,noexec,relatime,memory,nsroot=/)
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œï¼Œ/sys/fs/cgroup/memory ç›®å½•ä¾¿æŒ‚åœ¨äº† memory subsystem çš„ hierarchy ä¸Šã€‚ä¸‹é¢ï¼Œé€šè¿‡è¿™ä¸ª  hierarchy åˆ›å»º cgroupï¼Œè¿›è€Œé™åˆ¶è¿›ç¨‹å ç”¨çš„å†…å­˜</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>[memory] stress -vm-bytes 200m --vm-keep -m <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#007f7f"># åœ¨ä¸é™åˆ¶çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨ä¸€ä¸ªå ç”¨å†…å­˜çš„stresså†…å­˜</span>
</span></span><span style="display:flex;"><span>[memory] sudo mkdir test-limit-memory &amp;&amp; <span style="color:#fff;font-weight:bold">cd</span> test-limit-memory <span style="color:#007f7f"># åˆ›å»ºä¸€ä¸ª cgroup</span>
</span></span><span style="display:flex;"><span>[memory] sudo sh -c <span style="color:#0ff;font-weight:bold">&#34;echo &#34;</span>100m<span style="color:#0ff;font-weight:bold">&#34; &gt; memory.limit_in_bytes&#34;</span> <span style="color:#007f7f"># è®¾ç½®æœ€å¤§ cgroup çš„æœ€å¤§å†…å­˜å ç”¨ç”¨100MB</span>
</span></span><span style="display:flex;"><span>[memory] sudo sh -c <span style="color:#0ff;font-weight:bold">&#34;echo </span>$$<span style="color:#0ff;font-weight:bold"> &gt; tasks&#34;</span> <span style="color:#007f7f"># å°†å½“å‰è¿›ç¨‹ç§»åŠ¨åˆ°è¿™ä¸ªcgroupä¸­</span>
</span></span><span style="display:flex;"><span>[memory] stress --vm-bytes 200m --vm-keep -m <span style="color:#ff0;font-weight:bold">1</span> <span style="color:#007f7f"># å†æ¬¡å°è¯•å ç”¨200MBçš„è¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>[memory] top
</span></span><span style="display:flex;"><span>ï¼ƒé™åˆ¶åå†…å­˜å ç”¨çº¦100MB (2GB*5%ï¼‰
</span></span><span style="display:flex;"><span>PID PPID  TIME+   %CPU %MEM PR NI S VIRT      RES UID COMMAND 
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">8310</span> <span style="color:#ff0;font-weight:bold">8309</span> 0:01.17  7.6  5.0 <span style="color:#ff0;font-weight:bold">20</span> <span style="color:#ff0;font-weight:bold">0</span>  R <span style="color:#ff0;font-weight:bold">212284</span> <span style="color:#ff0;font-weight:bold">102056</span> <span style="color:#ff0;font-weight:bold">1000</span> stress 
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">8309</span> <span style="color:#ff0;font-weight:bold">7475</span> 0:00.00  0.0  0.0 <span style="color:#ff0;font-weight:bold">20</span> <span style="color:#ff0;font-weight:bold">0</span>  S <span style="color:#ff0;font-weight:bold">7480</span>      <span style="color:#ff0;font-weight:bold">796</span> <span style="color:#ff0;font-weight:bold">1000</span> stress
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="docker-ä½¿ç”¨-groups">Docker ä½¿ç”¨ Groups<a hidden class="anchor" aria-hidden="true" href="#docker-ä½¿ç”¨-groups">#</a></h2>
<p>Docker é€šè¿‡ Groups å®ç°å®¹å™¨èµ„æºé™åˆ¶å’Œç›‘æ§</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#007f7f"># docker run -m è®¾ç½®å†…å­˜</span>
</span></span><span style="display:flex;"><span>sudo docker run -itd -m 128m ubuntu
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#è¾“å‡ºï¼š957459145e9092618837cf94alcb356e206f2f0da560b40cb31035e442d3dfll</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># docker ä¼šä¸ºæ¯ä¸ªå®¹å™¨åœ¨ç³»ç»Ÿçš„ hierarchy ä¸­åˆ›å»º cgroup</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">cd</span> /sys/fs/cgroup/memory/docker/{{åˆšåˆšç”Ÿæˆçš„docker}}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#æŸ¥çœ‹ cgroup çš„å†…å­˜é™åˆ¶</span>
</span></span><span style="display:flex;"><span>cat memory.limit_in_bytes
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#è¾“å‡ºï¼š134217728</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#æŸ¥çœ‹ cgroup ä¸­è¿›ç¨‹æ‰€ä½¿ç”¨çš„å†…å­˜å¤§å°</span>
</span></span><span style="display:flex;"><span>cat memory.usage_in_bytes
</span></span><span style="display:flex;"><span><span style="color:#007f7f">#è¾“å‡ºï¼š430080</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹Ÿå°±æ˜¯ï¼Œå®¹å™¨ä¼šåˆ›å»º cgroupï¼Œç„¶åé€šè¿‡ cgroup å»é…ç½®èµ„æºé™åˆ¶å’Œèµ„æºç›‘æ§</p>
<h2 id="go-å®ç°é€šè¿‡-cgroup-é™åˆ¶å®¹å™¨èµ„æº">Go å®ç°é€šè¿‡ cgroup é™åˆ¶å®¹å™¨èµ„æº<a hidden class="anchor" aria-hidden="true" href="#go-å®ç°é€šè¿‡-cgroup-é™åˆ¶å®¹å™¨èµ„æº">#</a></h2>
<p>åœ¨ä¸Šè¿°çš„ Namespace çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Š cgroup çš„é™åˆ¶</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> main
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;io/ioutil&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;os/exec&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;path&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0ff;font-weight:bold">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// æŒ‚è½½äº† memory subsystem çš„ hierarchy çš„æ ¹ç›®å½•ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">const</span> cgroupMemoryHierarchyMount = <span style="color:#0ff;font-weight:bold">&#34;/sys/fs/cgroup/memory&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">func</span> main() {
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> os.Args[<span style="color:#ff0;font-weight:bold">0</span>] == <span style="color:#0ff;font-weight:bold">&#34;/proc/self/exe&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#007f7f">// å®¹å™¨è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>		fmt.Printf(<span style="color:#0ff;font-weight:bold">&#34;current pid %d\n&#34;</span>, syscall.Getpid())
</span></span><span style="display:flex;"><span>		cmd := exec.Command(<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;-c&#34;</span>, <span style="color:#0ff;font-weight:bold">`stress --vm-bytes 200m --vm-keep -m 1`</span>)
</span></span><span style="display:flex;"><span>		cmd.SysProcAttr = &amp;syscall.SysProcAttr{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>		cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>		cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">if</span> err := cmd.Run(); err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#fff;font-weight:bold">panic</span>(err)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	cmd := exec.Command(<span style="color:#0ff;font-weight:bold">&#34;/proc/self/exe&#34;</span>)
</span></span><span style="display:flex;"><span>	cmd.SysProcAttr = &amp;syscall.SysProcAttr{
</span></span><span style="display:flex;"><span>        Cloneflags : syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	cmd.Stdin = os.Stdin
</span></span><span style="display:flex;"><span>	cmd.Stdout = os.Stdout
</span></span><span style="display:flex;"><span>	cmd.Stderr = os.Stderr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">if</span> err := cmd.Start(); err != <span style="color:#fff;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">panic</span>(err)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// è¢« fork å‡ºæ¥è¿›ç¨‹æ˜ å°„åˆ°å¤–éƒ¨å‘½åç©ºé—´çš„ pid
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	fmt.Printf(<span style="color:#0ff;font-weight:bold">&#34;%v&#34;</span>, cmd.Process.Pid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// åœ¨ç³»ç»Ÿé»˜è®¤åˆ›å»ºæŒ‚è½½äº† memory subsystem çš„ hierarchy ä¸Šåˆ›å»º cgroup
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	os.Mkdir(path.Join(cgroupMemoryHierarchyMount, <span style="color:#0ff;font-weight:bold">&#34;testmemorylimit&#34;</span>), <span style="color:#ff0;font-weight:bold">0755</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// å°†å®¹å™¨è¿›ç¨‹åŠ å…¥åˆ°è¿™ä¸ª cgroup ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ioutil.WriteFile(path.Join(cgroupMemoryHierarchyMount, <span style="color:#0ff;font-weight:bold">&#34;testmemorylimit&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;tasks&#34;</span>),
</span></span><span style="display:flex;"><span>		[]<span style="color:#fff;font-weight:bold">byte</span>(strconv.Itoa(cmd.Process.Pid)), <span style="color:#ff0;font-weight:bold">0644</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#007f7f">// é™åˆ¶ cgroup è¿›ç¨‹ä½¿ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>	ioutil.WriteFile(path.Join(cgroupMemoryHierarchyMount, <span style="color:#0ff;font-weight:bold">&#34;testmemorylimit&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;memory.limit_in_bytes&#34;</span>),
</span></span><span style="display:flex;"><span>		[]<span style="color:#fff;font-weight:bold">byte</span>(<span style="color:#0ff;font-weight:bold">&#34;100m&#34;</span>), <span style="color:#ff0;font-weight:bold">0644</span>)
</span></span><span style="display:flex;"><span>	cmd.Process.Wait()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="union-file-system">Union File System<a hidden class="anchor" aria-hidden="true" href="#union-file-system">#</a></h1>
<p>ç®€ç§° UnionFSï¼Œä¸€ç§ä¸º Linuxã€FreeBSD å’Œ NetBSD æ“ä½œç³»ç»Ÿè®¾è®¡çš„ï¼ŒæŠŠ<strong>å…¶ä»–æ–‡ä»¶ç³»ç»Ÿè”åˆåˆ°ä¸€ä¸ªæŒ‚è½½ç‚¹</strong>çš„<strong>æ–‡ä»¶ç³»ç»ŸæœåŠ¡</strong></p>
<p>ä½¿ç”¨branch æŠŠä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶å’Œç›®å½•â€é€æ˜çš„è¦†ç›–â€œï¼Œå½¢æˆä¸€ä¸ªå•ä¸€ä¸€è‡´çš„æ–‡ä»¶ç³»ç»Ÿã€‚ä¹Ÿå°±æ˜¯ä¸ä¼šå­˜åœ¨å¤šå¤šï¼Œåœ¨ä¸åŒçš„æ–‡ä»¶ä¸‹ã€‚è€Œä¸”ï¼Œè¿™äº›branchä¼šè¢«é™åˆ¶æƒé™ï¼Œå³ read-only æˆ–è€… read-writeçš„ã€‚</p>
<p>å…¶å…·æœ‰ä¸€ä¸ªé‡è¦çš„èµ„æºç®¡ç†æŠ€æœ¯ï¼Œå« å†™æ—¶å¤åˆ¶ï¼ˆcopy-on-writeï¼Œç®€ç§° CoWï¼‰ï¼Œä¹Ÿè¢«ç§°ä¸ºéšå¼å…±äº«ï¼Œæ˜¯ä¸€ç§å¯¹èµ„æºå®ç°é«˜æ•ˆå¤åˆ¶çš„èµ„æºç®¡ç†æŠ€æœ¯ã€‚æ€æƒ³ä¸ºï¼Œè‹¥ä¸€ä¸ªèµ„æºçš„åˆ©ç”¨ä¸ºé‡å¤çš„ï¼Œä¸”æœªè¢«ä¿®æ”¹ï¼Œå°±ä¸éœ€è¦æ–°åˆ›å»ºï¼Œè¿™ä¸ªèµ„æºå¯è¢«æ–°æ—§å®ä¾‹å…±äº«ï¼Œä½•æ˜¯åˆ›å»ºï¼Ÿå½“å‘é€ç¬¬ä¸€æ¬¡å†™æ“ä½œæ—¶ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™æ ·å¯ä»¥å¸¦æ¥æœªä¿®æ”¹èµ„æºå¤åˆ¶å¸¦æ¥çš„æ¶ˆè€—ï¼Œä½†ä¹Ÿä¼šåœ¨è¿›è¡Œèµ„æºä¿®æ”¹æ—¶å¢åŠ å°éƒ¨åˆ†çš„å¼€é”€ã€‚</p>
<p>æ¢å¥è¯è¯´ï¼Œåœ¨è™šæ‹Ÿè”åˆæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¯¹æ–‡ä»¶è¿›è¡Œæ”¹åŠ¨ï¼Œçœ‹ä¼¼å¯¹åŸæ–‡ä»¶è¿›è¡Œäº†æ”¹åŠ¨ï¼Œå®åˆ™æ˜¯å†™å…¥åˆ°äº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¸­ã€‚</p>
<h2 id="aufs">AUFS<a hidden class="anchor" aria-hidden="true" href="#aufs">#</a></h2>
<p>Advanced Multi-Layered Unification Filesyetemï¼Œå®Œå…¨é‡å†™äº†æ—©èµ·çš„ UnionFS 1.xï¼Œä¸»è¦ç›®çš„ä¸ºäº†å¯é æ€§å’Œæ€§èƒ½ï¼Œå¹¶ä¸”å¼•å…¥äº†ä¸€äº›æ–°çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å¯å†™åˆ†æ”¯çš„è´Ÿè½½å‡è¡¡</p>
<p>ä¸»è¦åŠŸèƒ½ä¸ºæŠŠå¤šä¸ªç›®å½•ç»“åˆæˆä¸€ä¸ªç›®å½•ï¼Œå¯¹å¤–ä½¿ç”¨</p>
<p>æŠŠå¤šä¸ªç›®å½• mount æˆä¸€ä¸ªï¼Œè¯»å†™æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ€ä¸Šå±‚çš„ç›®å½•ä¸ºè¯»å†™å±‚ï¼Œåªèƒ½æœ‰ä¸€ä¸ª</li>
<li>ä¸‹é¢å¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªåªè¯»å±‚è¯»æ–‡ä»¶</li>
<li>è¯»æ–‡ä»¶ï¼Œä»æœ€ä¸Šé¢ä¸€ä¸ªå¼€å§‹å¾€ä¸‹é€å±‚å»æ‰¾ï¼Œæ‰“å¼€ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ–‡ä»¶ï¼Œè¯»å–å…¶ä¸­çš„å†…å®¹</li>
<li>å†™æ–‡ä»¶ï¼Œå¦‚æœåœ¨æœ€ä¸Šå±‚æ‰¾åˆ°äº†è¯¥æ–‡ä»¶ï¼Œç›´æ¥æ‰“å¼€
å¦åˆ™ï¼Œä»ä¸Šå¾€ä¸‹å¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°æ–‡ä»¶åï¼ŒæŠŠæ–‡ä»¶å¤åˆ¶åˆ°æœ€ä¸Šå±‚ï¼Œç„¶åå†æ‰“å¼€è¿™ä¸ª copy</li>
<li>åˆ é™¤æ–‡ä»¶ï¼šåœ¨æœ€ä¸Šå±‚åˆ›å»ºä¸€ä¸ª whiteout æ–‡ä»¶ï¼Œ.wh.&lt;origin_file_name&gt;ï¼Œå°±æ˜¯åœ¨åŸæ¥çš„æ–‡ä»¶åå­—å‰é¢åŠ ä¸Š .wh</li>
</ol>
<blockquote>
<p>Docker å¦‚ä½•ä½¿ç”¨ AUFSï¼Ÿ</p>
</blockquote>
<p>AUFS å…·æœ‰<strong>å¿«é€Ÿå¯åŠ¨å®¹å™¨</strong>ã€<strong>é«˜æ•ˆåˆ©ç”¨å­˜å‚¨</strong>å’Œ<strong>å†…å­˜</strong>çš„ä¼˜ç‚¹ã€‚å› æ­¤ï¼Œç›´åˆ°ç°åœ¨ä¸ºæ­¢ï¼ŒAUFSä¹Ÿæ˜¯Dockeræ”¯æŒçš„ä¸€ç§å­˜å‚¨é©±åŠ¨ç±»å‹</p>
<h3 id="image-layerå’Œaufs"><strong>image layerå’ŒAUFS</strong><a hidden class="anchor" aria-hidden="true" href="#image-layerå’Œaufs">#</a></h3>
<p>æ¯ä¸€ä¸ª Docker image éƒ½æ˜¯ç”±ä¸€ç³»åˆ— read-only layer ç»„æˆçš„ã€‚image layerçš„å†…å®¹éƒ½å­˜å‚¨åœ¨Docker hosts filesystem çš„ /var/lib/docker/aufs/diff ç›®å½•ä¸‹ã€‚è€Œ/var/lib/docker/aufs/layers ç›®å½•ï¼Œåˆ™å­˜å‚¨ç€ image layerå¦‚ä½•å †æ ˆè¿™äº›layerçš„metadata</p>
<p>åœ¨ Docker 1.11.2 ç‰ˆæœ¬ä¸‹ï¼Œæ²¡æœ‰ä»»ä½•é•œåƒï¼Œå¯åŠ¨å®¹å™¨ï¼Œç„¶åæ‰§è¡Œ<code>ls /var/lib/docker/aufs/diff</code>æŸ¥çœ‹ä¸ºç©º</p>
<p>ç„¶å</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#007f7f"># æ‹‰å– Ubuntu:15.04 é•œåƒ</span>
</span></span><span style="display:flex;"><span>$ docker pull ubuntu:15.04
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls /var/lib/docker/aufs/diff 
</span></span><span style="display:flex;"><span>208319b22189a2c3841bc4a4ef0df9f9238a3e832dc403133fb8ad4a6c22b01b 
</span></span><span style="display:flex;"><span>9c444e426a4a0aa3ad8ff162dd7bcd 4dcbb2e55bdec26Bb24666171904cl7573 
</span></span><span style="display:flex;"><span>6bb19cb345da470e015ba3flca049alc27d2c57ebc205ecl65d2ad8a44e14Bea 
</span></span><span style="display:flex;"><span>f193107618deb441376a54901bc9115f30473clec792b7fb3e73a98119e2cf77
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ls /var/lib/docker/aufs/mnt
</span></span><span style="display:flex;"><span>208319b22189a2c384lbc4a4ef0df9f923Ba3e832dc4031 33fb8ad4a6c22b01b 
</span></span><span style="display:flex;"><span>9c444e426a4a0aa3ad8ff162dd7bcd4dcbb2e55bdec268b24666171904cl7573 
</span></span><span style="display:flex;"><span>6bb19cb345da470e015ba3flca049alc27d2c57ebc205ecl65d2ad8a44el48ea 
</span></span><span style="display:flex;"><span>f193107618deb441376a54901bc9115f30473clec792b7fb3e73a98119e2cf77
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æŸ¥çœ‹æŸä¸ªlayerä¸‹çš„layer</span>
</span></span><span style="display:flex;"><span>$ cat /var/lib/docker/aufs/layers/6bb19cb345da470e015ba3flca049alc27d2c57ebc205ecl65d2ad8a44el48ea 
</span></span><span style="display:flex;"><span>9c444e426a4a0aa3ad8ff162dd7bcd4dcbb2e55bdec268b24666171904cl7573 
</span></span><span style="display:flex;"><span>fl93107618deb441376a54901bc9115f30473clec792b7fb3e73a98119e2cf77 
</span></span><span style="display:flex;"><span>208319b22189a2c384lbc4 a4 ef0df9f9238a3e832dc403133fb8ad4a6c22b01b
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¾ˆæ˜æ˜¾ï¼Œubuntu:15.04ä¸€å…±æœ‰4ä¸ªlayerï¼Œä¹Ÿå°±åœ¨æ‰§è¡Œå‘½ä»¤çš„ç»“æœä¸­ä¹Ÿæœ‰4ä¸ªå¯¹åº”çš„æ–‡ä»¶å­˜å‚¨ç›®å½•(<code>ls /var/lib/docker/aufs/diff</code>)</p>
<p>è¡¥å……ï¼šåœ¨ Docker 1.10 ä¹‹åï¼Œdiffç›®å½•ä¸‹å­˜å‚¨é•œåƒ layer æ–‡ä»¶å¤¹ä¸å†ä¸é•œåƒ ID ç›¸åŒäº†</p>
<blockquote>
<p>AUFS å¦‚ä½•èŠ‚çœç©ºé—´ï¼Ÿ</p>
</blockquote>
<p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª Dockerfile</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">From</span><span style="color:#0ff;font-weight:bold"> ubuntu:15.04</span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00">
</span></span></span><span style="display:flex;"><span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">RUN</span> <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;hello world&#34;</span> &gt; /tmp/newfile<span style="color:#f00">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#007f7f"># åˆ›å»ºimage</span>
</span></span><span style="display:flex;"><span>$ docker build -t change-ubuntu .
</span></span><span style="display:flex;"><span>$ docker <span style="color:#fff;font-weight:bold">history</span> change-ubuntu:latest 
</span></span><span style="display:flex;"><span>IMAGE          CREATED          CREATED BY                                      SIZE      COMMENT
</span></span><span style="display:flex;"><span>e7b7fc3bc0d0   <span style="color:#ff0;font-weight:bold">18</span> seconds ago   /bin/sh -c <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;hello world&#34;</span> &gt; /tmp/newfile    12B       
</span></span><span style="display:flex;"><span>d1b55fd07600   <span style="color:#ff0;font-weight:bold">6</span> years ago      /bin/sh -c <span style="color:#007f7f">#(nop) CMD [&#34;/bin/bash&#34;]             0B        </span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ff0;font-weight:bold">6</span> years ago      /bin/sh -c sed -i <span style="color:#0ff;font-weight:bold">&#39;s/^#\s*\(deb.*universe\)$â€¦   1.88kB    
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&lt;missing&gt;      6 years ago      /bin/sh -c echo &#39;</span><span style="color:#007f7f">#!/bin/sh&#39; &gt; /usr/sbin/poliâ€¦   701B      </span>
</span></span><span style="display:flex;"><span>&lt;missing&gt;      <span style="color:#ff0;font-weight:bold">6</span> years ago      /bin/sh -c <span style="color:#007f7f">#(nop) ADD file:3f4708cf445dc1b53â€¦   131MB  </span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ä¸Šé¢çš„ç»“æœçœ‹å‡ºæ¥ï¼Œe7b7fc3bc0d0 image layerä½äºæœ€ä¸Šå±‚ï¼Œåªæœ‰12Bçš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯<code>echo &quot;hello world&quot; &gt; /tmp/newfile</code>é€ æˆçš„ã€‚è€Œä¸‹é¢çš„å››å±‚image layerï¼Œåˆ™æ˜¯å…±äº«åœ°æ„æˆ ubuntu:15.04 é•œåƒçš„4ä¸ªimage layerã€‚å®é™…ä¸Šï¼Œæœ€ä¸Šå±‚çš„layerï¼Œä¹Ÿåªæ˜¯æœ‰ä¸€ä¸ª /tmp/newfileæ–‡ä»¶ï¼Œå†…å®¹ä¸º &ldquo;Hello world&rdquo;</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆå‡ºç°äº† missing æ ‡è®°ï¼Ÿ</p>
</blockquote>
<p>è‡ª Docker 1.10 ä¹‹åï¼Œä¸€ä¸ªé•œåƒçš„ image layerçš„ image history æ•°æ®éƒ½å­˜å‚¨åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­å¯¼è‡´çš„ï¼Œ</p>
<h3 id="container-layer-å’Œ-aufs">container layer å’Œ AUFS<a hidden class="anchor" aria-hidden="true" href="#container-layer-å’Œ-aufs">#</a></h3>
<p>é¦–å…ˆï¼Œå¯¹äºå®¹å™¨è€Œè¨€ï¼Œæ¯ä¸ªimage layeræœ€å¤šåªéœ€è¦å¤åˆ¶ä¸€æ¬¡ï¼Œåç»­çš„æ”¹åŠ¨éƒ½ä¼šåœ¨ç¬¬ä¸€æ¬¡æ‹·è´çš„ container layer ä¸Šè¿›è¡Œã€‚ä¹Ÿå°±æ˜¯ï¼Œåœ¨æ”¹åŠ¨å®¹å™¨å†…å®¹çš„æ—¶å€™ï¼Œåªä¼šå¤åˆ¶ä¸€æ¬¡é•œåƒå±‚çš„å†…å®¹è¿›è¡Œæ”¹åŠ¨</p>
<p>æ¯æ¬¡å¯åŠ¨ä¸€ä¸ª containerçš„æ—¶å€™ï¼ŒDockerä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ª read-only çš„ init layerï¼Œç”¨æ¥å­˜å‚¨ä¸è¿™ä¸ªå®¹å™¨å†…ç¯å¢ƒç›¸å…³çš„å†…å®¹ï¼›Docker è¿˜ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ª read-write çš„ layer æ¥æ‰§è¡Œæ‰€æœ‰å†™æ“ä½œã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶éƒ½åœ¨/var/lib/docker/aufs/diff ä¸‹ï¼Œread-onlyä¸º<container-id>-initï¼Œwrite-onlyä¸º<container-id></p>
<p>å¦å¤–ï¼Œcontainer layerçš„ mountç›®å½•ä¹Ÿæ˜¯ /var/lib/docker/aufs/mntã€‚</p>
<p>container çš„ metadata ï¼ˆå…ƒæ•°æ®ï¼‰å’Œé…ç½®æ–‡ä»¶éƒ½æ”¾åœ¨ /var/lib/docker/containers/<container-id> ç›®å½•ä¸­ã€‚</p>
<p>container çš„ read-write layer å­˜å‚¨åœ¨/var/lib/docker/aufs/diss/ç›®å½•ä¸‹ï¼Œè¿™æ ·ï¼Œå°±æ˜¯å®¹å™¨åœæ­¢äº†ï¼Œä¹Ÿä¸ä¼šå› ä¸ºé‡å¯å®¹å™¨è€Œå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œåªæœ‰å½“å®¹å™¨è¢«åˆ é™¤æ—¶ï¼Œè¿™ä¸ªè¯»å†™å±‚æ‰ä¼šè¢«ä¸€èµ·åˆ é™¤</p>
<p>container åˆ é™¤ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå‡è®¾ä¸ºåˆ é™¤file1ï¼Œä¼šåœ¨ read-write å±‚ç”Ÿæˆä¸€ä¸ª .wh.file1 çš„æ–‡ä»¶æ¥éšè—æ‰€æœ‰read-only å±‚ file1çš„æ–‡ä»¶ã€‚è·Ÿä¸Šè¿°çš„AUFSç®€ä»‹ç±»ä¼¼</p>
<h3 id="æ‰‹åŠ¨å®ç°-aufs">æ‰‹åŠ¨å®ç° AUFS<a hidden class="anchor" aria-hidden="true" href="#æ‰‹åŠ¨å®ç°-aufs">#</a></h3>
<p>é¦–å…ˆï¼Œå…ˆæ‰§è¡Œå¦‚ä¸‹æ“ä½œ</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#fff;font-weight:bold">cd</span> /home/anshun &amp;&amp; mkdir aufs
</span></span><span style="display:flex;"><span>$ <span style="color:#fff;font-weight:bold">cd</span> aufs
</span></span><span style="display:flex;"><span>$ mkdir container-layer mnt &amp;&amp; touch container-layer/container-layer.txt
</span></span><span style="display:flex;"><span>$ <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;I am container layer&#34;</span> &gt; container-layer/container-layer.txt
</span></span><span style="display:flex;"><span>$ <span style="color:#fff;font-weight:bold">for</span> i in {1..4}; <span style="color:#fff;font-weight:bold">do</span> mkdir image-layer$i; <span style="color:#fff;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#fff;font-weight:bold">for</span> i in {1..4}
</span></span><span style="display:flex;"><span>&gt; <span style="color:#fff;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>&gt; touch image-layer$i/image-layer$i.txt
</span></span><span style="display:flex;"><span>&gt; <span style="color:#fff;font-weight:bold">echo</span> <span style="color:#0ff;font-weight:bold">&#34;I am image layer </span><span style="color:#0ff;font-weight:bold">${</span>i<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">&#34;</span> &gt; image-layer$i/image-layer$i.txt
</span></span><span style="display:flex;"><span>&gt; <span style="color:#fff;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>$ tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>â”œâ”€â”€ container-layer
</span></span><span style="display:flex;"><span>â”‚Â Â  â””â”€â”€ container-layer.txt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ image-layer1
</span></span><span style="display:flex;"><span>â”‚Â Â  â””â”€â”€ image-layer1.txt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ image-layer2
</span></span><span style="display:flex;"><span>â”‚Â Â  â””â”€â”€ image-layer2.txt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ image-layer3
</span></span><span style="display:flex;"><span>â”‚Â Â  â””â”€â”€ image-layer3.txt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ image-layer4
</span></span><span style="display:flex;"><span>â”‚Â Â  â””â”€â”€ image-layer4.txt
</span></span><span style="display:flex;"><span>â””â”€â”€ mnt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">5</span> directories, <span style="color:#ff0;font-weight:bold">5</span> files
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åï¼ŒæŠŠ container-layer å’Œ å…¶å®ƒ4ä¸ªæ–‡ä»¶æŒ‚è½½åˆ° mnt ç›®å½•ä¸‹</p>
<p>åœ¨<code>mount aufs</code>å‘½ä»¤ä¸­ï¼Œè‹¥æ²¡æœ‰æŒ‡å®šå¾…æŒ‚è½½çš„æ–‡ä»¶çš„æƒé™ï¼Œé»˜è®¤ä¸º dirs æŒ‡å®šçš„å·¦è¾¹ç¬¬ä¸€ä¸ªç›®å½•ä¸º read-writeæƒé™ï¼Œåé¢éƒ½æ˜¯ read-only æƒé™</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mount -t aufs -o dirs=./container-layer:./image-layer4:./image-layer3:./image-layer2:./image-layer1 none ./mnt
</span></span><span style="display:flex;"><span>$ tree mnt
</span></span><span style="display:flex;"><span>mnt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ container-layer.txt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ image-layer1.txt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ image-layer2.txt
</span></span><span style="display:flex;"><span>â”œâ”€â”€ image-layer3.txt
</span></span><span style="display:flex;"><span>â””â”€â”€ image-layer4.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff0;font-weight:bold">0</span> directories, <span style="color:#ff0;font-weight:bold">5</span> files
</span></span><span style="display:flex;"><span>$ <span style="color:#fff;font-weight:bold">echo</span> -e <span style="color:#0ff;font-weight:bold">&#34;\nwrite to mnt&#39;s image-layer1.txt&#34;</span> &gt;&gt; ./mnt/image-layer4.txt 
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># æŸ¥çœ‹è™šæ‹ŸæŒ‚è½½ç‚¹çš„æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>$ cat ./mnt/image-layer4.txt 
</span></span><span style="display:flex;"><span>I am image layer <span style="color:#ff0;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>write to mnt<span style="color:#0ff;font-weight:bold">&#39;s image-layer1.txt
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"># æŸ¥çœ‹åŸæ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">$ cat image-layer4/image-layer4.txt 
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">I am image layer 4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold"># æŸ¥çœ‹ container-layerï¼Œå¤šäº†ä¸€ä¸ªimage-layer4.txtæ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">$ ll container-layer/
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">æ€»ç”¨é‡ 24
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">drwxr-xr-x 4 root root 4096 3æœˆ  13 18:59 ./
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">drwxr-xr-x 8 root root 4096 3æœˆ  13 18:31 ../
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-rw-r--r-- 1 root root   21 3æœˆ  13 18:17 container-layer.txt
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-rw-r--r-- 1 root root   52 3æœˆ  13 18:59 image-layer4.txt
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">-r--r--r-- 1 root root    0 3æœˆ  13 18:57 .wh..wh.aufs
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">drwx------ 2 root root 4096 3æœˆ  13 18:57 .wh..wh.orph/
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">drwx------ 2 root root 4096 3æœˆ  13 18:57 .wh..wh.plnk/
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">$ cat container-layer/image-layer4.txt 
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">I am image layer 4
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">write to mnt&#39;</span>s image-layer1.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹Ÿå°±æ˜¯ï¼Œåœ¨å°è¯•å¯¹mnt/image-layer4.txtçš„æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œç³»ç»Ÿä¼šå…ˆåœ¨mntç›®å½•ä¸‹æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œç„¶åå°†å…¶æ‹·è´åˆ° read-write å±‚çš„ç›®å½•ä¸­ï¼ˆè¿™é‡Œä¸ºcontainer-layerï¼‰ï¼Œæ¥ç€å¯¹å…¶æ‹·è´çš„æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œè€Œä¸å¯¹åŸæ–‡ä»¶è¿›è¡Œæ›´æ”¹ã€‚ç”±æ­¤ï¼Œä¹Ÿè¯æ˜äº†ä¸Šé¢æ‰€è¯´çš„lazyçš„æ€æƒ³</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/z-anshun/en/tags/docker/">Docker</a></li>
      <li><a href="http://localhost:1313/z-anshun/en/tags/books/">Books</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/z-anshun/en/posts/read/%E6%89%8B%E6%90%93docker/%E6%9E%84%E9%80%A0%E5%AE%B9%E5%99%A8%E5%92%8C%E9%95%9C%E5%83%8F/">
    <span class="title">Â« Prev</span>
    <br>
    <span>æ„é€ å®¹å™¨å’Œé•œåƒå®ç°åŸç†</span>
  </a>
  <a class="next" href="http://localhost:1313/z-anshun/en/posts/tech/linux/grep/">
    <span class="title">Next Â»</span>
    <br>
    <span>grep</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share åŸºç¡€æŠ€æœ¯ on x"
            href="https://x.com/intent/tweet/?text=%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af&amp;url=http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f&amp;hashtags=docker%2cbooks">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share åŸºç¡€æŠ€æœ¯ on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f&amp;title=%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af&amp;summary=%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af&amp;source=http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share åŸºç¡€æŠ€æœ¯ on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f&title=%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share åŸºç¡€æŠ€æœ¯ on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share åŸºç¡€æŠ€æœ¯ on whatsapp"
            href="https://api.whatsapp.com/send?text=%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af%20-%20http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share åŸºç¡€æŠ€æœ¯ on telegram"
            href="https://telegram.me/share/url?text=%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af&amp;url=http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share åŸºç¡€æŠ€æœ¯ on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=%e5%9f%ba%e7%a1%80%e6%8a%80%e6%9c%af&u=http%3a%2f%2flocalhost%3a1313%2fz-anshun%2fen%2fposts%2fread%2f%25E6%2589%258B%25E6%2590%2593docker%2f%25E5%259F%25BA%25E7%25A1%2580%25E6%258A%2580%25E6%259C%25AF%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/z-anshun/en/">Noodles2hgçš„åšå®¢</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
